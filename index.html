<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Langini Meteo ‚Äì Dashboard V8.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SunCalc per alba/tramonto -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root {
      --bg-top: #021b3c;
      --bg-bottom: #034f9a;
      --card-bg: #f8fbff;
      --card-border: #d0e0ff;
      --text-main: #0b1b3a;
      --text-muted: #6b7a99;
      --accent: #ffc107;
      --good: #00c853;
      --moderate: #ffca28;
      --bad: #ff7043;
      --danger: #d50000;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .sky {
      position: relative;
      flex: 1;
      background: linear-gradient(to bottom, #01224f, #0760c5);
      transition: background 0.8s ease;
      overflow: hidden;
    }

    .sky.night {
      background: radial-gradient(circle at 20% 0%, #243b6b, #020520 60%);
    }

    .stars {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.8s ease;
      background-image: radial-gradient(circle, rgba(255,255,255,0.8) 1px, transparent 1px);
      background-size: 3px 3px;
      mix-blend-mode: screen;
      z-index: 1;
    }

    .sky.night .stars {
      opacity: 0.35;
    }

    /* SOLE / LUNA ANIMATI */
    .sunmoon {
      position: absolute;
      top: 20%;
      left: -80px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      z-index: 2;
      transition: left 1.5s linear, top 1.5s linear;
    }

    .sun {
      background: radial-gradient(circle at 35% 35%, #fff8b0, #ffcc00, #ff9800);
      box-shadow: 0 0 25px 10px rgba(255,180,0,0.7);
    }

    .moon {
      background: radial-gradient(circle at 40% 40%, #ffffff, #cfd8dc);
      box-shadow: 0 0 20px 8px rgba(200,200,255,0.4);
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
      z-index: 3;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      text-align: center;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }

    header h1 span.version {
      font-size: 0.95rem;
      opacity: 0.7;
      margin-left: 4px;
    }

    header .subtitle {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .btn-realtime {
      display: inline-block;
      padding: 10px 24px;
      margin-top: 10px;
      background:#ff9500;
      color:#fff;
      font-weight:700;
      border-radius:14px;
      text-decoration:none;
      box-shadow:0 0 12px rgba(255,149,0,0.7);
      transition:0.2s;
      font-size:0.9rem;
    }
    .btn-realtime:hover {
      background:#ffb13c;
      box-shadow:0 0 18px rgba(255,149,0,1);
    }

    .status-bar {
      margin-top: 8px;
      font-size: 0.85rem;
      background: rgba(0, 0, 0, 0.25);
      padding: 6px 12px;
      border-radius: 999px;
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0f0;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.8);
    }

    .quality-banner {
      margin: 6px auto 0;
      padding: 10px 24px;
      border-radius: 999px;
      background: #ffc400;
      color: #202020;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: 0 0 20px rgba(255, 196, 0, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .quality-banner.good {
      background: #00e676;
      box-shadow: 0 0 20px rgba(0, 230, 118, 0.6);
    }

    .quality-banner.moderate {
      background: #ffeb3b;
      box-shadow: 0 0 20px rgba(255, 235, 59, 0.6);
    }

    .quality-banner.bad {
      background: #ff9100;
      box-shadow: 0 0 20px rgba(255, 145, 0, 0.6);
    }

    .quality-banner.very-bad {
      background: #ff1744;
      box-shadow: 0 0 20px rgba(255, 23, 68, 0.7);
      color: #fff;
    }

    .quality-banner span.icon {
      font-size: 1.1rem;
    }

    .sun-times {
      margin: 6px auto 0;
      padding: 6px 14px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.25);
      font-size: 0.85rem;
      display: inline-flex;
      gap: 12px;
      align-items: center;
    }

    .sun-times span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .cards {
      margin-top: 20px;
      display: grid;
      gap: 14px;
    }

    .cards-top {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .cards-bottom {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    @media (max-width: 1100px) {
      .cards-bottom {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      .cards-top {
        grid-template-columns: 1fr;
      }
      .cards-bottom {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      color: var(--text-main);
      border-radius: 16px;
      padding: 14px 14px 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      border: 1px solid var(--card-border);
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 140px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .card-header span.icon {
      font-size: 1.1rem;
    }

    .gauge {
      position: relative;
      height: 80px;
      margin-top: 4px;
    }

    .gauge-track {
      position: absolute;
      inset: auto 0 0;
      height: 16px;
      border-radius: 999px;
      background: #eceff4;
      overflow: hidden;
    }

    .gauge-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #ffb300, #ff6d00);
      transition: width 0.4s ease-out;
    }

    .value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-top: 8px;
    }

    .value-unit {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .card-footer {
      margin-top: auto;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .windmax-title {
      font-size: 0.95rem;
      font-weight: 600;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .windmax-value {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 10px;
    }

    .windmax-time {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .rainstate-value {
      font-size: 1.6rem;
      font-weight: 600;
      margin-top: 14px;
    }

    .rainstate-value.asciutto {
      color: #f57c00;
    }

    .rainstate-value.bagnato {
      color: #1565c0;
    }
  </style>
</head>
<body>
  <div class="sky" id="sky">
    <!-- Sole/Luna animati -->
    <div class="sunmoon" id="sunMoon"></div>

    <div class="stars"></div>
    <div class="content">
      <header>
        <h1>üåü Langini Meteo ‚Äì Dashboard <span class="version">V8.0</span></h1>
        <div class="subtitle">Meteo + Vento + Pioggia (storico) + Dati immediati + Cielo dinamico</div>

        <!-- Pulsante dati in tempo reale -->
        <a href="http://192.168.1.20" class="btn-realtime">
          ‚ö° Dati immediati (vento + pioggia)
        </a>

        <div class="status-bar" id="statusBar">
          <span class="status-dot"></span>
          <span id="statusText">Aggiornamento in corso‚Ä¶</span>
        </div>

        <div class="quality-banner moderate" id="qualityBanner">
          <span class="icon">‚ö†Ô∏è</span>
          <span id="qualityLabel">Qualit√† aria: --</span>
        </div>

        <div class="sun-times" id="sunTimes">
          <span>üåÖ <strong>Alba:</strong> --:--</span>
          <span>üåá <strong>Tramonto:</strong> --:--</span>
        </div>
      </header>

      <!-- RIGA SUPERIORE: VENTO MAX + PIOGGIA -->
      <section class="cards cards-top">
        <!-- Velocit√† Max -->
        <article class="card">
          <div class="windmax-title">
            <span>üåÄ Velocit√† Max Raggiunta</span>
          </div>
          <div class="windmax-value" id="windMaxValue">-- km/h</div>
          <div class="windmax-time" id="windMaxTime">--</div>
        </article>

        <!-- Stato Pioggia -->
        <article class="card">
          <div class="card-header">
            <span>üåßÔ∏è Pioggia</span>
          </div>
          <div class="rainstate-value" id="rainState">--</div>
        </article>
      </section>

      <!-- RIGA METEO: 4 CARD PRINCIPALI -->
      <section class="cards cards-bottom">
        <!-- Pressione -->
        <article class="card">
          <div class="card-header">
            <span>Pressione (hPa)</span>
            <span class="icon">üìà</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugePressure"></div>
            </div>
          </div>
          <div class="value">
            <span id="pressureValue">0</span>
          </div>
          <div class="value-unit">hPa</div>
          <div class="card-footer">Media oraria: <span id="pressureAvg">0.0</span></div>
        </article>

        <!-- Temperatura -->
        <article class="card">
          <div class="card-header">
            <span>Temperatura (¬∞C)</span>
            <span class="icon">üå°Ô∏è</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugeTemp"></div>
            </div>
          </div>
          <div class="value">
            <span id="tempValue">0</span>
          </div>
          <div class="value-unit">¬∞C</div>
          <div class="card-footer">Media oraria: <span id="tempAvg">0.0</span></div>
        </article>

        <!-- Umidit√† -->
        <article class="card">
          <div class="card-header">
            <span>Umidit√† (%)</span>
            <span class="icon">üíß</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugeHum"></div>
            </div>
          </div>
          <div class="value">
            <span id="humValue">0</span>
          </div>
          <div class="value-unit">% UR</div>
          <div class="card-footer">Media oraria: <span id="humAvg">0.0</span></div>
        </article>

        <!-- Qualit√† Aria -->
        <article class="card">
          <div class="card-header">
            <span>Qualit√† Aria (MQ135)</span>
            <span class="icon">üå±</span>
          </div>
          <div class="gauge">
            <div class="gauge-track">
              <div class="gauge-fill" id="gaugeAQ"></div>
            </div>
          </div>
          <div class="value">
            <span id="aqValue">0</span>
          </div>
          <div class="value-unit">AQI</div>
          <div class="card-footer">Media oraria: <span id="aqAvg">0.0</span></div>
        </article>
      </section>
    </div>
  </div>

  <script>
    // ================================
    //  CONFIG
    // ================================
    const METEO_CHANNEL = 3149218;   // pressione, temp, umidit√†, MQ135
    const WIND_CHANNEL  = 2956240;   // vento, pioggia

    const LAT = 45.7525;
    const LON = 8.8975;

    // ================================
    //  UTIL
    // ================================
    function toNumber(v, fallback = 0) {
      const n = parseFloat(v);
      return isNaN(n) ? fallback : n;
    }

    function averageField(feeds, fieldName) {
      if (!feeds || !feeds.length) return 0;
      let sum = 0;
      let count = 0;
      for (const f of feeds) {
        const v = toNumber(f[fieldName], NaN);
        if (!isNaN(v)) {
          sum += v;
          count++;
        }
      }
      return count ? sum / count : 0;
    }

    function formatTime(dateStr) {
      if (!dateStr) return "--:--:--";
      const d = new Date(dateStr);
      return d.toLocaleTimeString("it-IT", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }

    function clamp(val, min, max) {
      return Math.min(max, Math.max(min, val));
    }

    function classifyAir(aqi) {
      if (aqi <= 50) return { label: "Aria eccellente", cls: "good" };
      if (aqi <= 100) return { label: "Aria buona", cls: "good" };
      if (aqi <= 150) return { label: "Qualit√† moderata", cls: "moderate" };
      if (aqi <= 200) return { label: "Aria scadente", cls: "bad" };
      return { label: "Aria pessima", cls: "very-bad" };
    }

    // ================================
    //  ALBA / TRAMONTO + CIELO
    // ================================
    function updateSunTimes() {
      try {
        const now = new Date();
        const times = SunCalc.getTimes(now, LAT, LON);
        const sunrise = times.sunrise;
        const sunset = times.sunset;

        const sunriseStr = sunrise.toLocaleTimeString("it-IT", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const sunsetStr = sunset.toLocaleTimeString("it-IT", {
          hour: "2-digit",
          minute: "2-digit",
        });

        const sunTimesEl = document.getElementById("sunTimes");
        sunTimesEl.innerHTML =
          `<span>üåÖ <strong>Alba:</strong> ${sunriseStr}</span>` +
          `<span>üåá <strong>Tramonto:</strong> ${sunsetStr}</span>`;

        // Cielo giorno/notte gestito da updateSunMoonPosition
      } catch (e) {
        console.error("Errore SunCalc:", e);
      }
    }

    // ================================
    //  SOLE / LUNA IN MOVIMENTO
    // ================================
    function updateSunMoonPosition() {
      try {
        const now = new Date();
        const times = SunCalc.getTimes(now, LAT, LON);
        const sunrise = times.sunrise;
        const sunset = times.sunset;

        const sky = document.getElementById("sky");
        const sunMoon = document.getElementById("sunMoon");

        const isDay = now >= sunrise && now <= sunset;

        // Icona (sole o luna)
        if (isDay) {
          sunMoon.classList.add("sun");
          sunMoon.classList.remove("moon");
        } else {
          sunMoon.classList.add("moon");
          sunMoon.classList.remove("sun");
        }

        // Calcolo delta tempo
        let start = isDay ? sunrise : sunset;
        let end   = isDay ? sunset : new Date(sunrise.getTime() + 24*60*60*1000);

        let total = end - start;
        let current = now - start;

        let pct = total > 0 ? current / total : 0.5;
        if (pct < 0) pct = 0;
        if (pct > 1) pct = 1;

        // Orizzontale
        const screenWidth = window.innerWidth;
        const x = pct * (screenWidth + 160) - 80;

        // Curva verticale ad arco
        const maxHeight = window.innerHeight * 0.35;
        const y = maxHeight - Math.sin(pct * Math.PI) * maxHeight;

        sunMoon.style.left = `${x}px`;
        sunMoon.style.top = `${y}px`;

        // Cielo giorno/notte
        if (isDay) {
          sky.classList.remove("night");
        } else {
          sky.classList.add("night");
        }
      } catch (e) {
        console.error("Errore updateSunMoonPosition:", e);
      }
    }

    // ================================
    //  VENTO MAX (localStorage)
    // ================================
    let windMax = parseFloat(localStorage.getItem("windMax") || "0");
    let windMaxDate = localStorage.getItem("windMaxDate") || "--";

    function updateWindMaxDisplay() {
      document.getElementById("windMaxValue").textContent =
        windMax > 0 ? windMax.toFixed(1) + " km/h" : "-- km/h";
      document.getElementById("windMaxTime").textContent = windMaxDate;
    }

    updateWindMaxDisplay();

    // ================================
    //  FETCH THINGSPEAK & UPDATE UI
    // ================================
    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    async function updateDashboard() {
      try {
        const [meteoData, windData] = await Promise.all([
          fetchJson(
            `https://api.thingspeak.com/channels/${METEO_CHANNEL}/feeds.json?results=60`
          ),
          fetchJson(
            `https://api.thingspeak.com/channels/${WIND_CHANNEL}/feeds.json?results=60`
          ),
        ]);

        const feedsMeteo = meteoData.feeds || [];
        const feedsWind = windData.feeds || [];

        const lastMeteo = feedsMeteo[feedsMeteo.length - 1] || {};
        const lastWind = feedsWind[feedsWind.length - 1] || {};

        // ---- METEO ----
        const pressure = toNumber(lastMeteo.field1);
        const temp = toNumber(lastMeteo.field2);
        const hum = toNumber(lastMeteo.field3);
        const aqi = toNumber(lastMeteo.field4);

        document.getElementById("pressureValue").textContent =
          pressure.toFixed(0);
        document.getElementById("tempValue").textContent = temp.toFixed(0);
        document.getElementById("humValue").textContent = hum.toFixed(0);
        document.getElementById("aqValue").textContent = aqi.toFixed(0);

        document.getElementById("pressureAvg").textContent =
          averageField(feedsMeteo, "field1").toFixed(1);
        document.getElementById("tempAvg").textContent =
          averageField(feedsMeteo, "field2").toFixed(1);
        document.getElementById("humAvg").textContent =
          averageField(feedsMeteo, "field3").toFixed(1);
        document.getElementById("aqAvg").textContent =
          averageField(feedsMeteo, "field4").toFixed(1);

        const pressurePct = clamp(((pressure - 950) / (1050 - 950)) * 100, 0, 100);
        const tempPct = clamp(((temp + 10) / (50 + 10)) * 100, 0, 100);
        const humPct = clamp(hum, 0, 100);
        const aqPct = clamp((aqi / 500) * 100, 0, 100);

        document.getElementById("gaugePressure").style.width =
          pressurePct + "%";
        document.getElementById("gaugeTemp").style.width = tempPct + "%";
        document.getElementById("gaugeHum").style.width = humPct + "%";
        document.getElementById("gaugeAQ").style.width = aqPct + "%";

        // ---- VENTO + PIOGGIA ----
        const wind = toNumber(lastWind.field1);
        const rainFlag = toNumber(lastWind.field2);

        const rainStateEl = document.getElementById("rainState");
        if (rainFlag >= 1) {
          rainStateEl.textContent = "Bagnato";
          rainStateEl.classList.remove("asciutto");
          rainStateEl.classList.add("bagnato");
        } else {
          rainStateEl.textContent = "Asciutto";
          rainStateEl.classList.remove("bagnato");
          rainStateEl.classList.add("asciutto");
        }

        // vento max
        if (wind > windMax) {
          windMax = wind;
          const now = new Date();
          const hhmm = now.toLocaleTimeString("it-IT", {
            hour: "2-digit",
            minute: "2-digit",
          });
          const dstr = now.toLocaleDateString("it-IT");
          windMaxDate = `${hhmm} - ${dstr}`;
          localStorage.setItem("windMax", windMax.toFixed(1));
          localStorage.setItem("windMaxDate", windMaxDate);
        }
        updateWindMaxDisplay();

        const lastTime = lastWind.created_at || lastMeteo.created_at;
        const timeStr = formatTime(lastTime);
        const statusText = document.getElementById("statusText");
        statusText.textContent =
          `Aggiornato: ${timeStr} ‚Ä¢ Vento attuale: ${wind.toFixed(1)} km/h ‚Ä¢ Stato: ` +
          (rainFlag >= 1 ? "Pioggia" : "Asciutto");

        const qInfo = classifyAir(aqi);
        const qBanner = document.getElementById("qualityBanner");
        qBanner.classList.remove("good", "moderate", "bad", "very-bad");
        qBanner.classList.add(qInfo.cls);
        qBanner.querySelector("#qualityLabel").textContent = qInfo.label;

      } catch (err) {
        console.error("Errore aggiornamento dashboard:", err);
        document.getElementById("statusText").textContent =
          "Errore lettura dati ThingSpeak";
      }
    }

    // ================================
    //  AVVIO
    // ================================
    updateSunTimes();
    updateSunMoonPosition();
    updateDashboard();

    setInterval(updateDashboard, 20000);        // dati ogni 20s
    setInterval(updateSunTimes, 5 * 60 * 1000); // alba/tramonto ogni 5 min
    setInterval(updateSunMoonPosition, 10000);  // posizione sole/luna ogni 10s

    window.addEventListener("resize", updateSunMoonPosition);
  </script>
</body>
</html>
