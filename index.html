<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Langini Meteo ‚Äì Dashboard V9.2 (Luna 3D + Fasi Lunari)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root {
      --card-bg: #ffffff;
      --card-text: #000;
      --accent: #ffb300;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto;
      background:#000814;
      color:#fff;
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ====== OVERLAY PASSWORD ====== */
    #lockScreen {
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top, #1f2937, #020617);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
    }

    .lock-card {
      background:#0b1120;
      padding:24px 20px;
      border-radius:18px;
      box-shadow:0 18px 45px rgba(0,0,0,0.7);
      max-width:320px;
      width:90%;
      text-align:center;
      border:1px solid rgba(148,163,184,0.4);
    }

    .lock-title {
      font-size:1.1rem;
      margin-bottom:8px;
    }

    .lock-sub {
      font-size:0.85rem;
      color:#9ca3af;
      margin-bottom:14px;
    }

    .lock-input {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #4b5563;
      background:#020617;
      color:#e5e7eb;
      outline:none;
      margin-bottom:10px;
    }

    .lock-btn {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:none;
      background:#f97316;
      color:#fff;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 0 12px rgba(249,115,22,0.8);
    }

    .lock-btn:hover { filter:brightness(1.1); }

    .lock-error {
      margin-top:8px;
      font-size:0.8rem;
      color:#f97373;
      min-height:1em;
    }

    /* ====== CIELO ====== */
    .sky {
      position:relative;
      flex:1;
      background:#1f2b3a;
      transition:background 1.2s linear;
      overflow:hidden;
    }

    .sky.night { background:#000814; }

    /* ‚≠ê STELLE */
    .stars {
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:0;
      transition:opacity 1s ease;
    }

    .star {
      position:absolute;
      width:2px;
      height:2px;
      background:white;
      border-radius:50%;
      opacity:0;
      animation: twinkle 3s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%   { opacity:0; transform:scale(0.8); }
      50%  { opacity:1; transform:scale(1.5); }
      100% { opacity:0; transform:scale(0.8); }
    }

    /* ‚≠ê METEORE */
    .meteor {
      position:absolute;
      width:140px;
      height:3px;
      opacity:0;
      background:linear-gradient(90deg, rgba(255,255,255,1), transparent);
      transform:rotate(28deg);
      z-index:10;
      pointer-events:none;
    }

    @keyframes meteorMove {
      0%   { opacity:0; transform:translate(0,0) rotate(28deg); }
      10%  { opacity:1; }
      100% {
        opacity:0;
        transform:translate(var(--mx), var(--my)) rotate(28deg);
      }
    }

    /* ====== SOLE / LUNA (contenitore) ====== */
    .sunmoon {
      position:absolute;
      top:10%;
      left:-80px;
      width:70px;
      height:70px;
      border-radius:50%;
      z-index:3;
      transition:left 1.2s linear, top 1.2s linear;
      overflow:hidden;
    }

    /* SOLE */
    .sun {
      background:radial-gradient(circle at 35% 35%, #fff8b0, #ffcc00, #ff9800);
      box-shadow:0 0 25px 12px rgba(255,180,0,0.8);
      animation:sunPulse 5s infinite;
    }

    @keyframes sunPulse {
      0% {box-shadow:0 0 20px 8px rgba(255,180,0,0.5);}
      50%{box-shadow:0 0 32px 14px rgba(255,204,0,0.9);}
      100%{box-shadow:0 0 20px 8px rgba(255,180,0,0.5);}
    }

    /* LUNA 3D ‚Äì craterizzata (L1) */
    .moon {
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9) 0, rgba(255,255,255,0) 40%),
        radial-gradient(circle at 70% 40%, rgba(230,230,230,0.85) 0, rgba(230,230,230,0) 45%),
        radial-gradient(circle at 40% 70%, rgba(210,210,210,0.9) 0, rgba(210,210,210,0) 35%),
        radial-gradient(circle at 60% 65%, rgba(150,150,150,0.85) 0, rgba(150,150,150,0) 28%),
        radial-gradient(circle at 45% 45%, #f5f5f5 0, #d0d0d0 55%, #8b8b8b 100%);
      background-color:#d0d4dc;
      box-shadow:0 0 20px 10px rgba(190,200,255,0.7);
      position:relative;
      animation:moonRotate 60s linear infinite;
    }

    @keyframes moonRotate {
      0%   { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }

    .moon-phase-mask {
      position:absolute;
      inset:0;
      background:#000814;
      border-radius:50%;
      opacity:0.85;
      transition: transform 1s ease, opacity 1s ease;
    }

    /* FASI LUNARI (0 = Luna nuova, 4 = piena) */
    .sunmoon.phase-0 .moon-phase-mask {           /* nuova */
      transform:scaleX(1);
      opacity:0.98;
    }
    .sunmoon.phase-1 .moon-phase-mask {
      transform:translateX(-35%) scaleX(0.9);
    }
    .sunmoon.phase-2 .moon-phase-mask {
      transform:translateX(-20%) scaleX(0.6);
    }
    .sunmoon.phase-3 .moon-phase-mask {
      transform:translateX(-8%)  scaleX(0.3);
    }
    .sunmoon.phase-4 .moon-phase-mask {          /* piena */
      transform:scaleX(0.02);
      opacity:0;
    }
    .sunmoon.phase-5 .moon-phase-mask {
      transform:translateX(8%)  scaleX(0.3);
    }
    .sunmoon.phase-6 .moon-phase-mask {
      transform:translateX(20%) scaleX(0.6);
    }
    .sunmoon.phase-7 .moon-phase-mask {
      transform:translateX(35%) scaleX(0.9);
    }

    /* ====== CONTENUTO ====== */
    .content {
      position:relative;
      z-index:20;
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      margin-top:35vh;
    }

    h1 {
      text-align:center;
      margin-bottom:10px;
      font-size:1.3rem;
    }

    .sun-times {
      text-align:center;
      font-size:0.85rem;
      color:#e5e7eb;
      margin-bottom:12px;
      opacity:0.9;
    }

    .btn-wind-external {
      display:block;
      margin:14px auto 18px;
      padding:12px 22px;
      background:linear-gradient(135deg,#00aaff,#0077cc);
      color:white;
      font-size:1rem;
      font-weight:700;
      text-align:center;
      border-radius:12px;
      text-decoration:none;
      box-shadow:0 0 14px rgba(0,150,255,0.7);
      width:90%;
      max-width:330px;
      border:1px solid rgba(0,180,255,0.5);
      transition:0.2s;
    }

    .btn-wind-external:hover {
      filter:brightness(1.2);
    }

    .status-bar {
      text-align:center;
      margin-bottom:12px;
      font-size:0.9rem;
    }

    .cards { display:grid; gap:14px; }

    .bottom-cards {
      grid-template-columns:repeat(4,1fr);
    }

    @media(max-width:900px){
      .bottom-cards { grid-template-columns:1fr 1fr; }
    }
    @media(max-width:600px){
      .bottom-cards { grid-template-columns:1fr; }
      .content { margin-top:28vh; }
      h1 { font-size:1.1rem; }
      .sunmoon { width:60px; height:60px; top:8%; }
      .value { font-size:1.3rem; }
    }

    .card {
      background:#fff;
      color:#000;
      border-radius:16px;
      padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,0.25);
    }

    .card-header { font-weight:600; margin-bottom:4px; }
    .value { font-size:1.6rem; font-weight:700; margin-top:6px; }
    .value-unit { font-size:0.8rem; color:#666; }

    .gauge {
      height:12px;
      background:#e0e0e0;
      border-radius:12px;
      margin-top:6px;
    }

    .gauge-fill {
      height:100%;
      background:linear-gradient(90deg,#ffb300,#ff6d00);
      width:0%;
      transition:width .3s;
      border-radius:inherit;
    }
  </style>
</head>

<body>

<!-- PASSWORD -->
<div id="lockScreen">
  <div class="lock-card">
    <div class="lock-title">üîê Langini Meteo ‚Äì Accesso</div>
    <div class="lock-sub">Inserisci la password per visualizzare la dashboard.</div>
    <input type="password" id="lockPassword" class="lock-input" placeholder="Password" />
    <button id="lockButton" class="lock-btn">Entra</button>
    <div id="lockError" class="lock-error"></div>
  </div>
</div>

<!-- SFONDO -->
<div class="sky" id="sky">

  <div class="stars" id="stars"></div>

  <div class="meteor" id="meteor1"></div>
  <div class="meteor" id="meteor2"></div>

  <!-- SOLE / LUNA con fasi -->
  <div class="sunmoon" id="sunMoon">
    <div class="moon-phase-mask" id="moonMask"></div>
  </div>

  <!-- CONTENUTO -->
  <div class="content">
    <h1>üåü Langini Meteo ‚Äì Dashboard V9.2</h1>

    <div class="sun-times" id="sunTimes">Alba: --:-- ‚Ä¢ Tramonto: --:--</div>

    <!-- PULSANTE LINK ESTERNO VENTO/PIOGGIA -->
    <a href="https://972davide.github.io/Langini_Meteo_Wind.html"
       class="btn-wind-external">
       üå¨Ô∏è Apri Dashboard Vento / Pioggia (Web Esterno)
    </a>

    <div class="status-bar" id="statusText">Caricamento dati‚Ä¶</div>

    <div class="cards bottom-cards">

      <div class="card">
        <div class="card-header">Pressione</div>
        <div class="value" id="pressureValue">--</div>
        <div class="value-unit">hPa</div>
        <div class="gauge"><div class="gauge-fill" id="gaugePressure"></div></div>
      </div>

      <div class="card">
        <div class="card-header">Temperatura</div>
        <div class="value" id="tempValue">--</div>
        <div class="value-unit">¬∞C</div>
        <div class="gauge"><div class="gauge-fill" id="gaugeTemp"></div></div>
      </div>

      <div class="card">
        <div class="card-header">Umidit√†</div>
        <div class="value" id="humValue">--</div>
        <div class="value-unit">%</div>
        <div class="gauge"><div class="gauge-fill" id="gaugeHum"></div></div>
      </div>

      <div class="card">
        <div class="card-header">Qualit√† Aria</div>
        <div class="value" id="aqValue">--</div>
        <div class="value-unit">AQI</div>
        <div class="gauge"><div class="gauge-fill" id="gaugeAQ"></div></div>
      </div>

    </div>

  </div>
</div>

<!-- SCRIPT -->
<script>
  const PASSWORD = "Doroty025";
  const METEO_CHANNEL = 3149218;

  const LAT = 45.7525;
  const LON = 8.8975;

  let unlocked = false;

  function clamp(v,a,b){ return Math.min(b,Math.max(a,v)); }
  function toNum(v){ const n=parseFloat(v); return isNaN(n)?0:n; }

  /* ====== FASE LUNARE ====== */
  function moonPhaseIndex(date){
    const lp=2551443;
    const nm=Date.UTC(1970,0,7,20,35,0);
    const now=date.getTime();
    const phase=((now-nm)/1000)%lp;
    return Math.floor((phase/lp)*8+0.5)&7;
  }

  /* ====== CIELO / SOLE / LUNA ====== */
  function updateSky(){
    if(!unlocked) return;

    const now=new Date();
    const times=SunCalc.getTimes(now,LAT,LON);
    const pos=SunCalc.getPosition(now,LAT,LON);
    const alt=pos.altitude*180/Math.PI;

    const SKY=document.getElementById("sky");
    const SM=document.getElementById("sunMoon");
    const MASK=document.getElementById("moonMask");

    const isDay = now>=times.sunrise && now<=times.sunset;

    if(isDay){
      SM.classList.add("sun");
      SM.classList.remove("moon");
      MASK.style.display="none";
    } else {
      SM.classList.remove("sun");
      SM.classList.add("moon");
      MASK.style.display="block";

      const idx = moonPhaseIndex(now);
      for(let i=0;i<8;i++) SM.classList.remove("phase-"+i);
      SM.classList.add("phase-"+idx);
    }

    const start=isDay ? times.sunrise : times.sunset;
    const end=isDay ? times.sunset : new Date(times.sunrise.getTime()+86400000);
    let p=(now-start)/(end-start);
    p=clamp(p,0,1);

    const W = window.innerWidth;
    const base=window.innerHeight*0.05;
    const amp =window.innerHeight*0.20;
    const y=base + (1 - Math.sin(p*Math.PI)) * amp;

    SM.style.left=`${p*(W+160)-80}px`;
    SM.style.top =`${y}px`;

    const DAY="#1f2b3a";
    const NIGHT="#000814";

    let blend;
    const ALT_N=-12, ALT_D=45;

    if(alt<=ALT_N) blend=0;
    else if(alt>=ALT_D) blend=1;
    else blend=(alt-ALT_N)/(ALT_D-ALT_N);

    const rStart = parseInt(NIGHT.slice(1,3),16);
    const gStart = parseInt(NIGHT.slice(3,5),16);
    const bStart = parseInt(NIGHT.slice(5,7),16);
    const rEnd   = parseInt(DAY.slice(1,3),16);
    const gEnd   = parseInt(DAY.slice(3,5),16);
    const bEnd   = parseInt(DAY.slice(5,7),16);

    const r = Math.round(rStart + (rEnd-rStart)*blend);
    const g = Math.round(gStart + (gEnd-gStart)*blend);
    const b = Math.round(bStart + (bEnd-bStart)*blend);

    SKY.style.background = `rgb(${r},${g},${b})`;
    SKY.classList.toggle("night", alt<=0);
  }

  /* ====== STELLE ====== */
  document.getElementById("lockButton").addEventListener("click", () => {
  handleLogin();
});

document.getElementById("lockPassword").addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleLogin();
});

  function initStars(){
    const container=document.getElementById("stars");
    for(let i=0;i<90;i++){
      const s=document.createElement("div");
      s.className="star";
      s.style.top=Math.random()*100+"%";
      s.style.left=Math.random()*100+"%";
      s.style.animationDelay=(Math.random()*3)+"s";
      container.appendChild(s);
    }
  }

  function isNightTime(){
    const now=new Date();
    const t=SunCalc.getTimes(now,LAT,LON);
    return now<t.sunrise || now>t.sunset;
  }

  function toggleStars(){
    if(!unlocked) return;
    document.getElementById("stars").style.opacity = isNightTime() ? 1 : 0;
  }

  /* ====== METEORE ====== */
  function triggerMeteor(id) {
    if (!unlocked || !isNightTime()) return;

    const el = document.getElementById(id);

    const startX = -150 - Math.random() * 150;
    const startY = 2 + Math.random() * 40;

    const dx = 500 + Math.random() * 400;
    const dy = 150 + Math.random() * 200;

    el.style.left = startX + "px";
    el.style.top = startY + "vh";

    el.style.setProperty("--mx", dx + "px");
    el.style.setProperty("--my", dy + "px";

    el.style.animation = "none";
    void el.offsetWidth;
    el.style.animation = "meteorMove 1.3s linear forwards";

    setTimeout(() => el.style.opacity = 0, 1400);
  }

  function scheduleMeteors(){
    const delay=5000+Math.random()*7000;
    setTimeout(()=>{
      if(isNightTime()){
        triggerMeteor("meteor1");
        if(Math.random()<0.4) triggerMeteor("meteor2");
      }
      scheduleMeteors();
    },delay);
  }

  /* ====== DASHBOARD ‚Äì LETTURA DATI ====== */
  async function updateDashboard(){
    if(!unlocked) return;

    try{
      const meteo = await fetch(
        `https://api.thingspeak.com/channels/${METEO_CHANNEL}/feeds.json?results=1`
      ).then(r=>r.json());

      const m = meteo.feeds?.[0] || {};

      const pressure = toNum(m.field1);
      const temp     = toNum(m.field2);
      const hum      = toNum(m.field3);
      const aqi      = toNum(m.field4);

      // Valori
      document.getElementById("pressureValue").textContent =
        pressure ? pressure.toFixed(0) : "--";

      document.getElementById("tempValue").textContent =
        temp ? temp.toFixed(1) : "--";

      document.getElementById("humValue").textContent =
        hum ? hum.toFixed(0) : "--";

      document.getElementById("aqValue").textContent =
        aqi ? aqi.toFixed(0) : "--";

      // Barre
      document.getElementById("gaugePressure").style.width =
        clamp((pressure - 950) / 100 * 100, 0, 100) + "%";

      document.getElementById("gaugeTemp").style.width =
        clamp((temp + 10) / 60 * 100, 0, 100) + "%";

      document.getElementById("gaugeHum").style.width =
        clamp(hum, 0, 100) + "%";

      document.getElementById("gaugeAQ").style.width =
        clamp(aqi / 500 * 100, 0, 100) + "%";

      // Timestamp
      if(m.created_at) {
        document.getElementById("statusText").textContent =
          "Aggiornato: " + new Date(m.created_at).toLocaleTimeString("it-IT", {
            hour:"2-digit",
            minute:"2-digit"
          });
      }

    } catch(e){
      console.log("Errore updateDashboard:", e);
      document.getElementById("statusText").textContent = "Errore connessione";
    }
  }

  /* ====== SOLE / LUNA ‚Äì TESTO ALBA/TRAMONTO ====== */
  function updateSunTimes(){
    if(!unlocked) return;

    const now=new Date();
    const t=SunCalc.getTimes(now,LAT,LON);
    const f=d=>d.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
    document.getElementById("sunTimes").textContent =
      "Alba: "+f(t.sunrise)+" ‚Ä¢ Tramonto: "+f(t.sunset);
  }

  /* ====== LOOP PRINCIPALE CIELO ====== */
  function tickSky(){
    updateSky();
    toggleStars();
    updateSunTimes();
  }

  /* ====== LOGIN ====== */
  function doUnlock(){
    unlocked=true;
    document.getElementById("lockScreen").style.display="none";
    localStorage.setItem("langini_auth","ok");

    tickSky();
    updateDashboard();
  }

  function handleLogin(){
    const pwd=document.getElementById("lockPassword").value.trim();
    if(pwd===PASSWORD){
      doUnlock();
    } else {
      document.getElementById("lockError").textContent="Password errata.";
    }
  }

  function initAuth(){
    if(localStorage.getItem("langini_auth")==="ok"){
      doUnlock();
    }
  }

  /* ====== START ====== */
  initStars();
  initAuth();
  scheduleMeteors();

  setInterval(tickSky,10000);
  setInterval(updateDashboard,20000);

// Fix listener password
const btn = document.getElementById("lockButton");
const pwd = document.getElementById("lockPassword");

btn.addEventListener("click", () => {
  handleLogin();
});

pwd.addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleLogin();
});

</script>

</body>
</html>
