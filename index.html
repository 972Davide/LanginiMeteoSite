<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Langini Meteo ‚Äì Dashboard V8.8 FULL</title>

<style>
/* ============================
   STILE GENERALE
============================ */
body {
  margin: 0;
  background: #000814;
  overflow-x: hidden;
  font-family: 'Segoe UI', sans-serif;
  color: #ffffff;
  text-align: center;
}

/* ============================
   CARDS GENERALI
============================ */
.card {
  background: rgba(20, 20, 35, 0.75);
  padding: 22px;
  border-radius: 16px;
  box-shadow: 0 0 18px rgba(0,0,0,0.6);
  margin: 18px auto;
  width: 90%;
  max-width: 450px;
  backdrop-filter: blur(4px);
}
.card-header {
  font-size: 22px;
  margin-bottom: 8px;
  text-shadow: 0 0 12px #69aaff;
}

.cards {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 16px;
}

/* ============================
   CARD VENTO + PIOGGIA GRANDI
============================ */
.wind-card, .rain-card {
  padding: 26px !important;
  min-height: 260px;
}

.wind-value, .rainstate-value {
  font-size: 48px !important;
  font-weight: bold;
  margin-top: 10px;
}

.wind-extra {
  margin-top: 14px;
  font-size: 16px;
  opacity: 0.85;
}

.wind-chart-card {
  margin-top: 28px;
  padding: 20px !important;
}

/* ============================
   TESTI E STATUS
============================ */
.status-bar {
  margin-top: 14px;
  font-size: 17px;
  opacity: 0.8;
}

/* ============================
   ANIMAZIONI CIELO (GI√Ä ESISTENTI)
============================ */
.sunmoon {
  position: absolute;
  top: 120px;
  right: 20px;
  width: 140px;
  height: 140px;
  background: radial-gradient(circle, #fffde1, #ffe07d);
  border-radius: 50%;
  box-shadow: 0 0 45px #fff4cc;
}
.moon-phase-mask {
  position: absolute;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  background: #000814;
  left: 0;
  top: 0;
}

/* METEORE */
.shooting-star {
  position: absolute;
  width: 4px;
  height: 4px;
  background: white;
  box-shadow: 0 0 18px white;
  border-radius: 50%;
  opacity: 0;
  animation: meteor 4s linear infinite;
}

@keyframes meteor {
  0% { opacity: 0; transform: translate(-300px, -300px); }
  5% { opacity: 1; }
  100% { opacity: 0; transform: translate(600px, 300px); }
}
</style>

</head>
<body>

<!-- ============================
     TITOLO
============================ -->
<h1 style="margin-top:25px; font-size:26px; text-shadow:0 0 15px #00aaff;">
  üåü Langini Meteo ‚Äì Dashboard V8.8 FULL
</h1>
<div id="sunTimes" class="status-bar">Alba --:-- ‚Ä¢ Tramonto --:--</div>
<div id="statusText" class="status-bar">Caricamento dati...</div>

<!-- ============================
     ANIMAZIONI CIELO
============================ -->
<div class="sunmoon"><div class="moon-phase-mask" id="moonMask"></div></div>
<div class="shooting-star"></div>

<!-- ============================
     CARD VENTO + PIOGGIA
============================ -->
<div class="cards" id="windSection">

  <!-- CARD VENTO -->
  <div class="card wind-card">
    <div class="card-header"><span style="font-size:60px;">üå¨Ô∏è</span><br>Vento attuale</div>
    <div class="wind-value" id="windNow">-- km/h</div>

    <div class="wind-extra">
      <div id="windAvg">Media 24h: -- km/h</div>
      <div id="windKwh">Energia annua stimata: -- kWh</div>
    </div>
  </div>

  <!-- CARD PIOGGIA -->
  <div class="card rain-card">
    <div class="card-header"><span style="font-size:60px;">üåßÔ∏è</span><br>Stato Pioggia</div>
    <div class="rainstate-value" id="rainState">--</div>
  </div>

</div>

<!-- ============================
     GRAFICO VENTO 24H
============================ -->
<div class="card wind-chart-card">
  <div class="card-header" style="font-size:22px;">üìà Vento ‚Äì Ultime 24 ore</div>
  <iframe width="100%" height="260" style="border-radius:12px;border:none;"
    src="https://thingspeak.com/channels/2956240/charts/1?bgcolor=%23000814&color=%23ffffff&dynamic=true&results=288&title=Vento+24h&type=line">
  </iframe>
</div>


<!-- ============================
     JAVASCRIPT (VENTO + PIOGGIA + KWH)
============================ -->
<script>
const CHANNEL_ID = 2956240;
const READ_KEY = "2B5OCENVF8TW06WZ";

/* --- CALCOLO KWH EOLICI ANNUI --- */
function calcolaKwhAnnui(media_kmh) {
  let v = media_kmh / 3.6;  // km/h ‚Üí m/s
  let A = 0.85 * 0.59;      // area VAWT
  let rho = 1.225;
  let Cp = 0.25;
  let P = 0.5 * rho * A * Cp * Math.pow(v,3);
  let WhGiorno = P * 24;
  let kWhAnno = WhGiorno * 365 / 1000;
  return kWhAnno.toFixed(1);
}

/* --- LETTURA THINGSPEAK --- */
function aggiornaVentoPioggia() {

  fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_KEY}&results=288`)
    .then(r => r.json())
    .then(d => {

      let feeds = d.feeds;

      // Ultimo dato vento/pioggia
      let ultimo = feeds[feeds.length - 1];
      let ventoNow = parseFloat(ultimo.field1 || 0).toFixed(1);
      let pioggiaNow = ultimo.field2 === "1" ? "Pioggia" : "Asciutto";

      // Calcolo media 24h
      let sum = 0, count = 0;
      feeds.forEach(f => {
        if (f.field1) { sum += parseFloat(f.field1); count++; }
      });
      let media24 = (count > 0) ? (sum / count).toFixed(1) : 0;

      // Aggiorna CARD
      document.getElementById("windNow").innerHTML = ventoNow + " km/h";
      document.getElementById("windAvg").innerHTML = "Media 24h: " + media24 + " km/h";
      document.getElementById("windKwh").innerHTML = 
        "Energia annua stimata: " + calcolaKwhAnnui(media24) + " kWh";

      let rainElem = document.getElementById("rainState");
      rainElem.innerHTML = pioggiaNow;

      if (pioggiaNow === "Pioggia") {
        rainElem.style.color = "#ff6060";
      } else {
        rainElem.style.color = "#7cd8ff";
      }

      document.getElementById("statusText").innerHTML = "Aggiornato alle " + 
        new Date(ultimo.created_at).toLocaleTimeString();
    });
}

setInterval(aggiornaVentoPioggia, 15000);
aggiornaVentoPioggia();
</script>

</body>
</html>
