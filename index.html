<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Langini Meteo ‚Äì Dashboard V8.7 NIGHT SKY AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root {
      --card-bg: #ffffff;
      --card-text: #000;
      --accent: #ffb300;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto;
      background:#000814;
      color:#fff;
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ====== LOCK SCREEN ====== */
    #lockScreen {
      position:fixed;
      inset:0;
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
    }

    .lock-card {
      background:#0b1120;
      padding:24px 20px;
      border-radius:18px;
      box-shadow:0 18px 45px rgba(0,0,0,0.7);
      max-width:320px;
      width:90%;
      text-align:center;
      border:1px solid rgba(148,163,184,0.4);
    }

    .lock-title { font-size:1.15rem; margin-bottom:10px; }
    .lock-sub { font-size:0.85rem; color:#9ca3af; margin-bottom:15px; }

    .lock-input {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #475569;
      background:#020617;
      color:#e2e8f0;
      outline:none;
      margin-bottom:10px;
    }
    .lock-btn {
      width:100%;
      padding:10px;
      border:none;
      background:#f97316;
      color:white;
      border-radius:10px;
      font-weight:600;
      box-shadow:0 0 12px rgba(249,115,22,0.8);
    }
    .lock-error { font-size:0.80rem; margin-top:6px; color:#f87171; }

    /* ====== SKY ====== */
    .sky {
      position:relative;
      flex:1;
      background:#1f2b3a;
      transition:background 1.2s linear;
      overflow:hidden;
    }
    .sky.night { background:#000814; }

    /* ‚≠ê STARS */
    .stars {
      position:absolute;
      inset:0;
      z-index:0;
      opacity:0;
      transition:opacity 1s ease;
      pointer-events:none;
    }

    .star {
      position:absolute;
      width:2px;
      height:2px;
      background:white;
      border-radius:50%;
      opacity:0;
      animation: twinkle 3s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%   { opacity:0; transform:scale(0.8); }
      50%  { opacity:1; transform:scale(1.5); }
      100% { opacity:0; transform:scale(0.8); }
    }

    /* üå† METEORS */
    .meteor {
      position:absolute;
      width:140px;
      height:3px;
      opacity:0;
      background:linear-gradient(90deg, rgba(255,255,255,1), transparent);
      transform:rotate(30deg);
      z-index:10;
    }
    @keyframes meteorMove {
      0%   { opacity:0; transform:translate(0,0) rotate(30deg); }
      10%  { opacity:1; }
      100% { opacity:0; transform:translate(600px,300px) rotate(30deg); }
    }

    /* üåü COMET */
    .comet {
      position:absolute;
      top:12vh;
      left:-200px;
      width:60px;
      height:60px;
      border-radius:50%;
      background:radial-gradient(circle, #fff, #ffe9a3, #ffcd00);
      box-shadow:0 0 25px 12px rgba(255,200,0,0.7);
      opacity:0;
      transition:left 2s linear, top 2s linear, opacity 1.2s ease;
      z-index:9;
    }
    .comet.big {
      width:140px;
      height:140px;
      box-shadow:0 0 55px 25px rgba(255,240,0,1);
    }
    .comet-tail {
      position:absolute;
      right:100%;
      top:50%;
      transform:translateY(-50%);
      width:220px;
      height:40px;
      background:linear-gradient(90deg, rgba(255,255,200,0.6), transparent);
      filter:blur(7px);
    }

    /* SHOOTING STAR */
    .shooting-star {
      position:absolute;
      top:-5%;
      left:-5%;
      width:120px;
      height:2px;
      background:linear-gradient(90deg, rgba(255,255,255,0.9), transparent);
      opacity:0;
      transform:rotate(25deg);
      z-index:4;
    }
    .shooting-star.active {
      animation: shooting 1.3s ease-out forwards;
    }
    @keyframes shooting {
      0% {opacity:0; transform:translate(-10vw,-10vh) rotate(25deg);}
      20%{opacity:1;}
      100%{opacity:0; transform:translate(40vw,40vh) rotate(25deg);}
    }

    /* SOLE / LUNA */
    .sunmoon {
      position:absolute;
      top:10%;
      left:-80px;
      width:70px;
      height:70px;
      border-radius:50%;
      z-index:3;
      transition:left 1.2s linear, top 1.2s linear;
    }

    .sun {
      background:radial-gradient(circle,#fffdb8,#ffd000,#ff9800);
      box-shadow:0 0 25px 12px rgba(255,180,0,0.8);
      animation:sunPulse 5s infinite;
    }
    @keyframes sunPulse {
      0% {box-shadow:0 0 20px 8px rgba(255,180,0,0.5);}
      50%{box-shadow:0 0 32px 14px rgba(255,204,0,0.9);}
      100%{box-shadow:0 0 20px 8px rgba(255,180,0,0.5);}
    }

    .moon {
      background:radial-gradient(circle,#fff,#d1d5db);
      box-shadow:0 0 18px 8px rgba(200,200,255,0.5);
      animation:moonGlow 6s infinite;
      position:relative;
    }
    @keyframes moonGlow {
      0% {box-shadow:0 0 14px 5px rgba(200,200,255,0.25);}
      50%{box-shadow:0 0 18px 9px rgba(220,220,255,0.6);}
      100%{box-shadow:0 0 14px 5px rgba(200,200,255,0.25);}
    }

    .moon-phase-mask {
      position:absolute;
      inset:0;
      background:#000814;
      border-radius:50%;
    }

    /* CONTENUTO */
    .content {
      position:relative;
      z-index:20;
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      margin-top:35vh;
    }
    h1 {
      text-align:center;
      font-size:1.3rem;
      margin-bottom:6px;
    }
    .sun-times {
      text-align:center;
      font-size:0.9rem;
      opacity:0.85;
      margin-bottom:6px;
    }

    .btn-realtime {
      display:block;
      width:200px;
      margin:0 auto 14px;
      padding:10px 15px;
      border-radius:12px;
      background:#ff9500;
      color:white;
      text-align:center;
      box-shadow:0 0 12px rgba(255,149,0,0.8);
      font-weight:600;
    }

    .status-bar {
      text-align:center;
      margin-bottom:10px;
      font-size:0.9rem;
    }

    .cards { display:grid; gap:14px; }
    .top-cards { grid-template-columns:1fr 1fr; }
    .bottom-cards { grid-template-columns:repeat(4,1fr); }

    @media(max-width:900px){
      .bottom-cards { grid-template-columns:1fr 1fr; }
    }
    @media(max-width:600px){
      .top-cards, .bottom-cards { grid-template-columns:1fr; }
    }

    .card {
      background:white;
      color:#000;
      border-radius:16px;
      padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,0.25);
    }
    .card-header { font-weight:600; }
    .value { font-size:1.6rem; font-weight:700; }
    .value-unit { font-size:0.8rem; color:#666; }

    .gauge {
      height:12px;
      background:#e5e7eb;
      border-radius:12px;
      margin-top:5px;
    }
    .gauge-fill {
      height:100%;
      border-radius:inherit;
      background:linear-gradient(90deg,#ffb300,#ff6d00);
      width:0%;
      transition:width .35s;
    }

    .rainstate-value {
      text-align:center;
      font-size:2rem;
    }
    .rainstate-value.asciutto { color:#f57c00; }
    .rainstate-value.bagnato { color:#1e88e5; }

    .windmax-value {
      text-align:center;
      font-size:2rem;
      font-weight:700;
      color:black;
    }
  </style>
</head>

<body>

<!-- PASSWORD -->
<div id="lockScreen">
  <div class="lock-card">
    <div class="lock-title">üîê Langini Meteo</div>
    <div class="lock-sub">Inserisci la password per accedere</div>
    <input id="lockPassword" type="password" class="lock-input" placeholder="Password" />
    <button id="lockButton" class="lock-btn">Entra</button>
    <div id="lockError" class="lock-error"></div>
  </div>
</div>

<div class="sky" id="sky">

  <!-- Stelle -->
  <div class="stars" id="stars"></div>

  <!-- Meteore -->
  <div class="meteor" id="meteor1"></div>
  <div class="meteor" id="meteor2"></div>

  <!-- Cometa -->
  <div class="comet" id="comet"><div class="comet-tail"></div></div>

  <!-- Shooting star -->
  <div class="shooting-star" id="shootingStar"></div>

  <!-- Sole/Luna -->
  <div class="sunmoon" id="sunMoon"><div class="moon-phase-mask" id="moonMask"></div></div>

  <!-- Dashboard -->
  <div class="content">
    <h1>üåü Langini Meteo ‚Äì Dashboard V8.7</h1>
    <div id="sunTimes" class="sun-times">Alba: --:-- ‚Ä¢ Tramonto: --:--</div>

    <a href="http://192.168.1.20" class="btn-realtime">‚ö° Dati immediati</a>
    <div class="status-bar" id="statusText">Caricamento...</div>

    <div class="cards top-cards">
      <div class="card">
        <div class="card-header">üåÄ Velocit√† Max</div>
        <div class="windmax-value" id="windMaxValue">--</div>
        <div id="windMaxTime" style="font-size:0.75rem;color:#666;text-align:center"></div>
      </div>

      <div class="card">
        <div class="card-header">üåßÔ∏è Pioggia</div>
        <div class="rainstate-value" id="rainState">--</div>
      </div>
    </div>

    <div class="cards bottom-cards">
      <div class="card">
        <div class="card-header">Pressione</div>
        <div class="value" id="pressureValue">--</div>
        <div class="value-unit">hPa</div>
        <div class="gauge"><div id="gaugePressure" class="gauge-fill"></div></div>
      </div>

      <div class="card">
        <div class="card-header">Temperatura</div>
        <div class="value" id="tempValue">--</div>
        <div class="value-unit">¬∞C</div>
        <div class="gauge"><div id="gaugeTemp" class="gauge-fill"></div></div>
      </div>

      <div class="card">
        <div class="card-header">Umidit√†</div>
        <div class="value" id="humValue">--</div>
        <div class="value-unit">%</div>
        <div class="gauge"><div id="gaugeHum" class="gauge-fill"></div></div>
      </div>

      <div class="card">
        <div class="card-header">Qualit√† Aria</div>
        <div class="value" id="aqValue">--</div>
        <div class="value-unit">AQI</div>
        <div class="gauge"><div id="gaugeAQ" class="gauge-fill"></div></div>
      </div>
    </div>
  </div>
</div>

<script>
/* CONFIG */
const PASSWORD="Doroty025";
const LAT=45.7525, LON=8.8975;
const METEO_CHANNEL=3149218;
const WIND_CHANNEL=2956240;

let unlocked=false;

/* UTILS */
function clamp(v,a,b){ return Math.min(b,Math.max(a,v)); }
function toNum(x){ const n=parseFloat(x); return isNaN(n)?0:n; }

/* === NIGHT LOGIC === */
function isNightTime(){
  const now=new Date();
  const t=SunCalc.getTimes(now,LAT,LON);
  return now<t.sunrise || now>t.sunset;
}

/* PASSWORD */
function handleLogin(){
  const p=document.getElementById("lockPassword").value;
  if(p===PASSWORD){
    unlocked=true;
    localStorage.setItem("langini_auth","ok");
    document.getElementById("lockScreen").style.display="none";
    initEverything();
  } else {
    document.getElementById("lockError").textContent="Password errata.";
  }
}
document.getElementById("lockButton").onclick=handleLogin;
document.getElementById("lockPassword").onkeydown=e=>{ if(e.key==="Enter") handleLogin(); };

if(localStorage.getItem("langini_auth")==="ok"){
  unlocked=true;
  window.onload=()=> document.getElementById("lockScreen").style.display="none";
}

/* STARS */
function initStars(){
  const c=document.getElementById("stars");
  for(let i=0;i<90;i++){
    const s=document.createElement("div");
    s.className="star";
    s.style.top=Math.random()*100+"%";
    s.style.left=Math.random()*100+"%";
    s.style.animationDelay=Math.random()*3+"s";
    c.appendChild(s);
  }
}
function toggleStars(){
  document.getElementById("stars").style.opacity=isNightTime()?1:0;
}

/* METEORS */
function triggerMeteor(id){
  if(!isNightTime()) return;
  const el=document.getElementById(id);
  const startY=5+Math.random()*35;
  const startX=-300-Math.random()*300;
  el.style.top=startY+"vh";
  el.style.left=startX+"px";
  el.style.animation="none";
  void el.offsetWidth;
  el.style.animation="meteorMove 1.2s linear forwards";
}
function scheduleMeteors(){
  const t=5000+Math.random()*6000;
  setTimeout(()=>{
    if(isNightTime()){
      triggerMeteor("meteor1");
      if(Math.random()<0.5) triggerMeteor("meteor2");
    }
    scheduleMeteors();
  },t);
}

/* SHOOTING STAR */
function maybeStar(){
  if(isNightTime() && Math.random()<0.2){
    const s=document.getElementById("shootingStar");
    s.classList.add("active");
    setTimeout(()=>s.classList.remove("active"),1300);
  }
}

/* COMET */
function updateComet(){
  const c=document.getElementById("comet");
  const now=new Date();
  const m=now.getMonth();
  const d=now.getDate();
  if(m!==11 || d<1 || d>25){ c.style.opacity=0; return; }

  const w=window.innerWidth;
  c.style.opacity=1;

  if(d<25){
    const p=(d-1)/24;
    c.classList.remove("big");
    c.style.left=(-200+p*(w+200))+"px";
    c.style.top="12vh";
  } else {
    c.classList.add("big");
    c.style.left=(w/2-70)+"px";
    c.style.top="15vh";
  }
}

/* SUN & SKY */
function updateSky(){
  const now=new Date();
  const times=SunCalc.getTimes(now,LAT,LON);
  const pos=SunCalc.getPosition(now,LAT,LON);
  const alt=pos.altitude*180/Math.PI;
  const sky=document.getElementById("sky");
  const sm=document.getElementById("sunMoon");
  const mask=document.getElementById("moonMask");

  const day=now>=times.sunrise && now<=times.sunset;

  if(day){
    sm.className="sunmoon sun";
    mask.style.display="none";
  } else {
    sm.className="sunmoon moon";
    mask.style.display="block";
    const phase=moonPhaseIndex(now);
    for(let i=0;i<8;i++) sm.classList.remove("phase-"+i);
    sm.classList.add("phase-"+phase);
  }

  const start=day?times.sunrise:times.sunset;
  const end=day?times.sunset:new Date(times.sunrise.getTime()+86400000);
  let p=(now-start)/(end-start);
  p=clamp(p,0,1);

  const w=window.innerWidth;
  const topBase=window.innerHeight*0.05;
  const amp=window.innerHeight*0.20;
  const y=topBase+(1-Math.sin(p*Math.PI))*amp;

  sm.style.left=(p*(w+160)-80)+"px";
  sm.style.top=y+"px";

  const DAY="#1f2b3a", NIGHT="#000814";
  const ALT_N=-12, ALT_D=45;
  let blend;
  if(alt<=ALT_N) blend=0;
  else if(alt>=ALT_D) blend=1;
  else blend=(alt-ALT_N)/(ALT_D-ALT_N);

  sky.style.background=interpolateColor(NIGHT,DAY,blend);
  if(alt<=0) sky.classList.add("night");
  else sky.classList.remove("night");
}

function moonPhaseIndex(now){
  const lp=2551443;
  const nm=Date.UTC(1970,0,7,20,35,0);
  const phase=((now-nm)/1000)%lp;
  return Math.floor((phase/lp)*8+0.5)&7;
}

/* ALBA & TRAMONTO */
function updateSunTimes(){
  const t=SunCalc.getTimes(new Date(),LAT,LON);
  const f=d=>d.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
  document.getElementById("sunTimes").textContent=
    "Alba: "+f(t.sunrise)+" ‚Ä¢ Tramonto: "+f(t.sunset);
}

/* THINGSPEAK */
let windMax=parseFloat(localStorage.getItem("windMax")||"0");
let windMaxTime=localStorage.getItem("windMaxTime")||"--";

function updateWindMaxDisp(){
  document.getElementById("windMaxValue").textContent=
    windMax?windMax.toFixed(1)+" km/h":"--";
  document.getElementById("windMaxTime").textContent=windMaxTime;
}

async function updateDashboard(){
  if(!unlocked) return;
  try{
    const m=await fetch(`https://api.thingspeak.com/channels/${METEO_CHANNEL}/feeds.json?results=1`).then(r=>r.json());
    const w=await fetch(`https://api.thingspeak.com/channels/${WIND_CHANNEL}/feeds.json?results=1`).then(r=>r.json());

    const mf=m.feeds?.[0]||{}, wf=w.feeds?.[0]||{};

    const p=toNum(mf.field1);
    const t=toNum(mf.field2);
    const h=toNum(mf.field3);
    const q=toNum(mf.field4);

    document.getElementById("pressureValue").textContent=p?p.toFixed(0):"--";
    document.getElementById("tempValue").textContent=t?t.toFixed(0):"--";
    document.getElementById("humValue").textContent=h?h.toFixed(0):"--";
    document.getElementById("aqValue").textContent=q?q.toFixed(0):"--";

    document.getElementById("gaugePressure").style.width=clamp((p-950)/100*100,0,100)+"%";
    document.getElementById("gaugeTemp").style.width=clamp((t+10)/60*100,0,100)+"%";
    document.getElementById("gaugeHum").style.width=h+"%";
    document.getElementById("gaugeAQ").style.width=clamp(q/500*100,0,100)+"%";

    const rain=toNum(wf.field2);
    const rEl=document.getElementById("rainState");
    if(rain>=1){
      rEl.textContent="Bagnato";
      rEl.classList.add("bagnato");
      rEl.classList.remove("asciutto");
    } else {
      rEl.textContent="Asciutto";
      rEl.classList.add("asciutto");
      rEl.classList.remove("bagnato");
    }

    const ws=toNum(wf.field1);
    if(ws>windMax){
      windMax=ws;
      windMaxTime=new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})+
      " - "+new Date().toLocaleDateString("it-IT");
      localStorage.setItem("windMax",windMax.toFixed(1));
      localStorage.setItem("windMaxTime",windMaxTime);
    }
    updateWindMaxDisp();

    document.getElementById("statusText").textContent =
      "Aggiornato: "+new Date(wf.created_at||mf.created_at).toLocaleTimeString("it-IT");

  }catch(e){ console.warn("Errore TS:",e); }
}

/* START EVERYTHING */
function initEverything(){
  initStars();
  updateSunTimes();
  updateSky();
  updateDashboard();
  updateComet();
  toggleStars();
  scheduleMeteors();
}

setInterval(()=>{ if(unlocked){ updateSky(); toggleStars(); updateComet(); updateSunTimes(); } },10000);
setInterval(()=>{ if(unlocked) updateDashboard(); },20000);
setInterval(()=>{ if(unlocked) maybeStar(); },15000);

</script>

</body>
</html>
