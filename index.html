<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Langini Meteo ‚Äì Dati in tempo reale</title>

<!-- Librerie -->
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.5.0/justgage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>

<style>
html,body{
  margin:0;padding:0;height:100%;
  font-family:Arial,Helvetica,sans-serif;
  color:#fff;text-align:center;
  overflow:hidden;
}

/* ====== TITOLO SCORREVOLE ====== */
header{
  position:relative;
  background:rgba(0,0,0,0.25);
  overflow:hidden;
  padding:10px 0;
  height:50px;
  backdrop-filter:blur(6px);
  z-index:10;
}
header h1{
  position:absolute;
  white-space:nowrap;
  font-size:1.6em;
  font-weight:700;
  animation:scrollTitle 15s linear infinite;
  color:#fff;
  text-shadow:0 0 6px #aeeaff,0 0 12px #66ccff;
}
@keyframes scrollTitle{
  0%{left:100%;}
  100%{left:-100%;}
}

/* ====== CIELO ====== */
#sky{
  position:relative;
  width:100%;
  height:100vh;
  overflow:hidden;
  background:linear-gradient(to bottom,#001028,#002a4f);
  transition:background 5s ease;    /* üîÜ transizione graduale del cielo */
}
#stars{position:absolute;inset:0;pointer-events:none;z-index:1}
.star{
  position:absolute;width:2px;height:2px;
  background:#fff;border-radius:50%;
  opacity:0;animation:twinkle 4s infinite;
}
@keyframes twinkle{0%,100%{opacity:0}50%{opacity:1}}

.body{
  position:absolute;
  width:130px;height:130px;
  border-radius:50%;
  top:30%;left:-20%;
  transform:translate(-50%,-50%);
  will-change:transform,opacity;
  z-index:2;
}
#sun{
  background:radial-gradient(circle at 30% 30%,#fff68d 10%,#ffb400 60%,#ff6600 100%);
  box-shadow:0 0 60px 18px rgba(255,200,50,.6);
}
#moon{
  background:radial-gradient(circle at 40% 40%,#e0f0ff 25%,#7fa9ff 100%);
  box-shadow:0 0 40px 12px rgba(120,160,255,.3);
  opacity:.95;
}

/* ====== ALBA/TRAMONTO ====== */
#astroCountdown{
  position:absolute;
  z-index:3;
  background:rgba(0,0,0,0.6);
  padding:8px 20px;
  border-radius:12px;
  font-size:1.1em;
  font-weight:600;
  color:#fff;
  text-shadow:0 0 5px #000;
  transform:translate(-50%, -130%);
  box-shadow:0 0 8px rgba(0,0,0,0.4);
  pointer-events:none;
  animation:float 3s ease-in-out infinite alternate;
}
@keyframes float {
  from { transform:translate(-50%, -130%) translateY(0px); }
  to   { transform:translate(-50%, -130%) translateY(-3px); }
}

/* ====== GAUGE ====== */
#gauges{
  position:absolute;
  bottom:12%;
  left:50%;
  transform:translateX(-50%);
  width:100%;
  z-index:5;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:25px;
  background:linear-gradient(to top,rgba(0,0,40,0.75) 0%,rgba(0,0,40,0.0) 100%);
  padding:25px 0 35px;
}
.gaugeBox{
  background:none;
  border:none;
  box-shadow:none;
  width:270px;
  height:240px;
  color:#fff;
}
.label{font-size:1.15em;font-weight:700;margin-top:4px;color:#cce6ff}
.value{font-size:1.1em;font-weight:700;color:#fff}
.mean{font-size:.95em;color:#a0c4ff}

/* ====== SOTTO GAUGE ====== */
#underGauges{
  position:absolute;
  bottom:2%;
  left:50%;
  transform:translateX(-50%);
  width:100%;
  text-align:center;
  z-index:6;
}
#underGauges .btn{
  color:#fff;background:rgba(0,0,0,0.35);
  padding:10px 18px;border-radius:10px;
  text-decoration:none;font-weight:700;
  margin-bottom:10px;
  display:inline-block;
  backdrop-filter:blur(5px);
}
#underGauges .btn:hover{background:rgba(0,0,0,0.5);}
#underGauges footer{
  font-size:.9em;
  color:#a9c9ff;
  margin:0;
}

/* ====== MOBILE ====== */
@media (max-width:700px){
  .gaugeBox{width:180px;height:180px;}
  #gauges{gap:10px;padding:15px 0 20px;}
  #underGauges{bottom:3%;}
}
</style>
</head>

<body>
<header>
  <h1>üå§Ô∏è Langini Meteo ‚Äì Dati in tempo reale</h1>
</header>

<div id="sky">
  <div id="stars"></div>
  <div id="sun" class="body" style="display:none;"></div>
  <div id="moon" class="body" style="display:none;"></div>
  <div id="astroCountdown">...</div>

  <div id="gauges">
    <div class="gaugeBox">
      <div id="g1" style="height:150px"></div>
      <div class="label">Pressione (hPa)</div>
      <div class="value">Live: <span id="v1">--</span></div>
      <div class="mean">Media oraria: <span id="m1">--</span></div>
    </div>
    <div class="gaugeBox">
      <div id="g2" style="height:150px"></div>
      <div class="label">Temperatura (¬∞C)</div>
      <div class="value">Live: <span id="v2">--</span></div>
      <div class="mean">Media oraria: <span id="m2">--</span></div>
    </div>
    <div class="gaugeBox">
      <div id="g3" style="height:150px"></div>
      <div class="label">Umidit√† (%)</div>
      <div class="value">Live: <span id="v3">--</span></div>
      <div class="mean">Media oraria: <span id="m3">--</span></div>
    </div>
    <div class="gaugeBox">
      <div id="g4" style="height:150px"></div>
      <div class="label">Qualit√† Aria (MQ135)</div>
      <div class="value">Live: <span id="v4">--</span></div>
      <div class="mean">Media oraria: <span id="m4">--</span></div>
    </div>
  </div>

  <div id="underGauges">
    <a href="grafici.html" class="btn">üìä Vedi Grafici Dettagliati</a>
    <footer>¬© 2025 Langini Meteo ‚Ä¢ Aggiornamento automatico ogni 30 s</footer>
  </div>
</div>

<script>
const LAT=41.8933,LON=12.4829;
const CHANNEL_ID=3149218,API_KEY="4EGG4DXUFDU6FUGN";

// Stelle
(function makeStars(){
  const N=80,box=document.getElementById('stars');
  for(let i=0;i<N;i++){
    const s=document.createElement('div');
    s.className='star';
    s.style.left=(Math.random()*100)+'%';
    s.style.top=(Math.random()*100)+'%';
    s.style.animationDelay=(Math.random()*4)+'s';
    s.style.opacity=(0.4+Math.random()*0.6).toFixed(2);
    box.appendChild(s);
  }
})();

// Alba/tramonto
let timesToday=null,timesTomorrow=null;
function computeTimes(){
  const now=new Date();
  const d0=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const d1=new Date(d0.getTime()+86400000);
  timesToday=SunCalc.getTimes(d0,LAT,LON);
  timesTomorrow=SunCalc.getTimes(d1,LAT,LON);
}
computeTimes();
setInterval(()=>{let n=new Date();if(n.getHours()===0&&n.getMinutes()<2)computeTimes();},60000);

function lerp(a,b,t){return a+(b-a)*t}
function clamp01(x){return Math.max(0,Math.min(1,x))}
function timeProgress(t1,t2,n){return clamp01((n-t1)/(t2-t1))}
function mixColor(c1,c2,p){
  const r=Math.round(lerp(c1[0],c2[0],p)).toString(16).padStart(2,'0');
  const g=Math.round(lerp(c1[1],c2[1],p)).toString(16).padStart(2,'0');
  const b=Math.round(lerp(c1[2],c2[2],p)).toString(16).padStart(2,'0');
  return r+g+b;
}

// Aggiorna cielo gradualmente
function updateSky(){
  const now=new Date();
  const sunrise=timesToday.sunrise;
  const sunset=timesToday.sunset;
  const nextSunrise=timesTomorrow.sunrise;
  const isDay=(now>=sunrise&&now<sunset);
  const sky=document.getElementById('sky');

  const TW=60*60000; // durata crepuscolo: 1 ora
  let bg1,bg2;
  if(now>=new Date(sunrise-TW)&&now<new Date(sunrise+TW)){
    const p=timeProgress(sunrise-TW,sunrise+TW,now);
    bg1=`#${mixColor([0x00,0x10,0x28],[0xff,0xa4,0x52],p)}`;
    bg2=`#${mixColor([0x00,0x2a,0x4f],[0x34,0x56,0xa0],p)}`;
  }else if(now>=new Date(sunset-TW)&&now<new Date(sunset+TW)){
    const p=timeProgress(sunset-TW,sunset+TW,now);
    bg1=`#${mixColor([0x7e,0xc9,0xff],[0xff,0xa4,0x52],p)}`;
    bg2=`#${mixColor([0x2b,0x77,0xd0],[0x34,0x56,0xa0],p)}`;
  }else if(isDay){bg1='7ec9ff';bg2='2b77d0';}
  else{bg1='001028';bg2='002a4f';}
  sky.style.background=`linear-gradient(to bottom,#${bg1},#${bg2})`;

  const sun=document.getElementById('sun');
  const moon=document.getElementById('moon');
  const stars=document.getElementById('stars');
  const label=document.getElementById('astroCountdown');

  if(isDay){
    sun.style.display='block';moon.style.display='none';stars.style.display='none';
    const p=timeProgress(sunrise,sunset,now);
    const x=lerp(-10,110,p);
    const y=30-15*Math.sin(Math.PI*p);
    sun.style.left=x+'%';
    sun.style.top=y+'%';
    label.style.left=x+'%';
    label.style.top=(y-5)+'%';
  }else{
    sun.style.display='none';moon.style.display='block';stars.style.display='block';
    const moonStart=sunset,moonEnd=nextSunrise;
    const p=timeProgress(moonStart,moonEnd,now);
    const x=lerp(-10,110,p);
    const y=35-10*Math.sin(Math.PI*p);
    moon.style.left=x+'%';
    moon.style.top=y+'%';
    label.style.left=x+'%';
    label.style.top=(y-6)+'%';
  }

  // Countdown
  let target,icon;
  if(isDay){target=sunset;icon="‚òÄÔ∏è";}
  else{target=sunrise>now?sunrise:nextSunrise;icon="üåô";}
  const diff=target-now;
  const h=Math.floor(diff/3600000);
  const m=Math.floor((diff%3600000)/60000);
  label.innerHTML=`${icon} ${isDay?"Tramonto":"Alba"} tra <b>${h}h ${m}min</b>`;
}
updateSky();
setInterval(updateSky,30000); // ogni 30s aggiorna colore gradualmente

// Gauges
const g1=new JustGage({id:"g1",value:0,min:950,max:1050,gaugeWidthScale:.8,counter:true,pointer:true});
const g2=new JustGage({id:"g2",value:0,min:-10,max:50,gaugeWidthScale:.8,counter:true,pointer:true});
const g3=new JustGage({id:"g3",value:0,min:0,max:100,gaugeWidthScale:.8,counter:true,pointer:true});
const g4=new JustGage({id:"g4",value:0,min:0,max:500,gaugeWidthScale:.8,counter:true,pointer:true});

async function updateGauges(){
  try{
    const res=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&results=60`);
    const data=await res.json();
    if(!data.feeds||!data.feeds.length)return;
    const f=data.feeds.map(x=>({f1:+x.field1,f2:+x.field2,f3:+x.field3,f4:+x.field4}));
    const last=f[f.length-1];
    const mean=a=>(a.reduce((s,v)=>s+(isFinite(v)?v:0),0)/a.filter(x=>isFinite(x)).length).toFixed(1);
    g1.refresh(last.f1);g2.refresh(last.f2);g3.refresh(last.f3);g4.refresh(last.f4);
    document.getElementById("v1").textContent=last.f1.toFixed(1);
    document.getElementById("v2").textContent=last.f2.toFixed(1);
    document.getElementById("v3").textContent=last.f3.toFixed(1);
    document.getElementById("v4").textContent=last.f4.toFixed(1);
    document.getElementById("m1").textContent=mean(f.map(x=>x.f1));
    document.getElementById("m2").textContent=mean(f.map(x=>x.f2));
    document.getElementById("m3").textContent=mean(f.map(x=>x.f3));
    document.getElementById("m4").textContent=mean(f.map(x=>x.f4));
  }catch(e){console.error(e);}
}
updateGauges();
setInterval(updateGauges,30000);
</script>
</body>
</html>
