<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Langini Meteo ‚Äì Dashboard V8.9</title>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>

/* ======================================
   STILI GENERALI
====================================== */
body {
  margin: 0;
  background: #000814;
  font-family: system-ui, Arial;
  color: #fff;
  overflow-x: hidden;
}

/* ======================================
   CIELO (pi√π grande)
====================================== */
.sky {
  position:relative;
  background:#001026;
  height:44vh;       /* aumentato */
  overflow:hidden;
  transition: background 1.2s linear;
}

@media(max-width:600px){
  .sky { height:40vh; }
}

/* Sole/Luna */
.sunmoon {
  position:absolute;
  top:14%;
  left:-120px;
  width:110px;
  height:110px;
  border-radius:50%;
  z-index:5;
  transition: left 1.2s linear, top 1.2s linear;
}

.sun {
  background: radial-gradient(circle, #fff7b0, #ffcc00, #ff9800);
  box-shadow:0 0 35px #ffb300;
}

.moon {
  background: radial-gradient(circle, #ffffff, #d0d3d7);
  box-shadow:0 0 22px #cad7ff;
}

/* Maschera fasi lunari */
.moon-phase-mask {
  position:absolute;
  inset:0;
  border-radius:50%;
  background:#001026;
}

/* ======================================
   STELLA CADENTE
====================================== */
.shooting-star {
  position:absolute;
  width:3px;
  height:3px;
  background:white;
  border-radius:50%;
  opacity:0;
  animation: meteor 4s linear infinite;
}

@keyframes meteor {
  0%   { opacity:0; transform: translate(-300px,-300px); }
  10%  { opacity:1; }
  100% { opacity:0; transform: translate(600px,300px); }
}

/* ======================================
   CONTENUTO DASHBOARD
====================================== */
.content {
  position:relative;
  z-index:20;
  max-width:1200px;
  margin:0 auto;
  padding:16px;
  margin-top:-2vh;      /* per far vedere molto cielo ma card subito visibili */
  text-align:center;
}

h1 {
  margin-top:10px;
  font-size:1.6rem;
  text-shadow:0 0 15px #008cff;
}

.sun-times {
  margin-top:4px;
  opacity:0.9;
}

/* STATO */
.status-bar {
  margin-top:8px;
  opacity:0.8;
}

/* ======================================
   CARD GENERALI
====================================== */
.cards {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:18px;
}

.card {
  background: rgba(20,20,35,0.75);
  padding:22px;
  border-radius:16px;
  width: 44%;
  min-width:260px;
  box-shadow:0 0 18px rgba(0,0,0,0.6);
  backdrop-filter: blur(5px);
}

.card-header {
  font-size:1.3rem;
  margin-bottom:6px;
}

/* CARD GRANDI PER VENTO / PIOGGIA */
.wind-card, .rain-card {
  padding:26px !important;
}

.wind-value, .rain-value {
  font-size:2.4rem;
  font-weight:bold;
  margin-top:10px;
}

.wind-extra {
  font-size:0.9rem;
  margin-top:12px;
  opacity:0.9;
}

/* CARD METEO BASE */
.bottom-cards {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:18px;
  margin-top:20px;
}

.bottom-card {
  background:rgba(25,25,40,0.8);
  padding:18px;
  border-radius:14px;
  text-align:center;
  box-shadow:0 0 14px rgba(0,0,0,0.4);
}

.value {
  margin-top:6px;
  font-size:1.9rem;
  font-weight:bold;
}

.unit {
  opacity:0.7;
  margin-top:2px;
}

/* MOBILE FIX */
@media(max-width:600px){
  .card { width:90%; }
  .bottom-cards { grid-template-columns:1fr; }
}

</style>
</head>

<body>

<!-- ======================================
     CIELO
====================================== -->
<div class="sky" id="sky">
  <div class="sunmoon" id="sunMoon">
    <div class="moon-phase-mask" id="moonMask"></div>
  </div>
  <div class="shooting-star"></div>
</div>

<!-- ======================================
     DASHBOARD
====================================== -->
<div class="content">

  <h1>üåü Langini Meteo ‚Äì Dashboard V8.9</h1>
  <div id="sunTimes" class="sun-times">Alba --:-- ‚Ä¢ Tramonto --:--</div>
  <div id="statusText" class="status-bar">Caricamento dati...</div>

  <!-- =======================
       CARD VENTO + PIOGGIA
  ======================== -->
  <div class="cards">

    <div class="card wind-card">
      <div class="card-header">üå¨Ô∏è Vento attuale</div>
      <div id="windNow" class="wind-value">-- km/h</div>

      <div class="wind-extra">
        <div id="windAvg">Media 24h: -- km/h</div>
        <div id="windKwh">Energia annua stimata: -- kWh</div>
      </div>
    </div>

    <div class="card rain-card">
      <div class="card-header">üåßÔ∏è Stato Pioggia</div>
      <div id="rainState" class="rain-value">--</div>
    </div>

  </div>

  <!-- =======================
       CARD METEO BASE
  ======================== -->
  <div class="bottom-cards">

    <div class="bottom-card">
      <div class="card-header">üå°Ô∏è Temperatura</div>
      <div id="tempValue" class="value">--</div>
      <div class="unit">¬∞C</div>
    </div>

    <div class="bottom-card">
      <div class="card-header">üíß Umidit√†</div>
      <div id="humValue" class="value">--</div>
      <div class="unit">%</div>
    </div>

    <div class="bottom-card">
      <div class="card-header">üå™Ô∏è Pressione</div>
      <div id="pressureValue" class="value">--</div>
      <div class="unit">hPa</div>
    </div>

    <div class="bottom-card">
      <div class="card-header">üå´Ô∏è Qualit√† Aria</div>
      <div id="aqValue" class="value">--</div>
      <div class="unit">AQI</div>
    </div>

  </div>

</div>

<!-- ======================================
     JAVASCRIPT
====================================== -->
<script>

const LAT = 45.7525;
const LON = 8.8975;

/* -----------------------------------
   Lettura dati da ThingSpeak
----------------------------------- */
const CH_METEO = 3149218;   // Temperature, pressure, humidity, AQ
const CH_WIND  = 2956240;   // Wind + rain
const READ_KEY = "2B5OCENVF8TW06WZ";

/* --- Calcolo energia annua kWh --- */
function calcKwh(media_kmh){
  let v = media_kmh / 3.6;
  let A = 0.85 * 0.59;
  let rho = 1.225;
  let Cp = 0.25;
  let P = 0.5 * rho * A * Cp * v*v*v;
  let kWh = P * 24 * 365 / 1000;
  return kWh.toFixed(1);
}

/* --- Aggiornamento principale --- */
async function updateDashboard(){

  try {

    /* --- DATI METEO --- */
    const meteo = await fetch(
      `https://api.thingspeak.com/channels/${CH_METEO}/feeds.json?results=1`
    ).then(r=>r.json());

    const m = meteo.feeds[0];
    document.getElementById("tempValue").innerText = m.field2;
    document.getElementById("humValue").innerText  = m.field3;
    document.getElementById("pressureValue").innerText = m.field1;
    document.getElementById("aqValue").innerText   = m.field4;

    /* --- DATI VENTO/PIOGGIA --- */
    const wind = await fetch(
      `https://api.thingspeak.com/channels/${CH_WIND}/feeds.json?results=288`
    ).then(r=>r.json());

    let last = wind.feeds[wind.feeds.length-1];

    let ventoNow = parseFloat(last.field1||0).toFixed(1);
    document.getElementById("windNow").innerText = ventoNow + " km/h";

    let rain = last.field2 === "1" ? "Pioggia" : "Asciutto";
    let rainEl = document.getElementById("rainState");
    rainEl.innerText = rain;
    rainEl.style.color = rain==="Pioggia" ? "#ff7070" : "#7cd8ff";

    // Media 24h
    let sum = 0, count=0;
    wind.feeds.forEach(f=>{
      if(f.field1){ sum+=parseFloat(f.field1); count++; }
    });
    let media24 = count>0 ? (sum/count).toFixed(1) : 0;
    document.getElementById("windAvg").innerText =
      "Media 24h: " + media24 + " km/h";

    // Energia annua
    document.getElementById("windKwh").innerText =
      "Energia annua stimata: " + calcKwh(media24) + " kWh";


    document.getElementById("statusText").innerText =
      "Aggiornato alle " + new Date(last.created_at).toLocaleTimeString();

  }catch(e){
    document.getElementById("statusText").innerText = "Errore connessione";
  }
}

setInterval(updateDashboard, 15000);
updateDashboard();

/* -----------------------------------
   Aggiornamento cielo (sole/luna)
----------------------------------- */
function updateSky(){
  const now = new Date();
  const times = SunCalc.getTimes(now, LAT, LON);
  const pos = SunCalc.getPosition(now, LAT, LON);
  const alt = pos.altitude * 180 / Math.PI;

  const SM = document.getElementById("sunMoon");
  const MASK = document.getElementById("moonMask");
  const SKY = document.getElementById("sky");

  const isDay = now >= times.sunrise && now <= times.sunset;

  if(isDay){
    SM.classList.add("sun");
    SM.classList.remove("moon");
    MASK.style.display="none";
    SKY.style.background = "#1c2d48";
  } else {
    SM.classList.remove("sun");
    SM.classList.add("moon");
    MASK.style.display="block";
    SKY.style.background = "#000814";
  }

  // Sole/luna in cielo
  const p = (now - times.sunrise) / (times.sunset - times.sunrise);
  const W = window.innerWidth;
  SM.style.left = p * (W+240) - 120 + "px";
}

setInterval(updateSky, 10000);
updateSky();

</script>
</body>
</html>
