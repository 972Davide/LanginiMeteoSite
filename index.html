<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Langini Meteo ‚Äì Dashboard V8.9.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto;
      background:#000814;
      color:#fff;
      overflow-x:hidden;
    }

    /* ======================================
       CIELO (pi√π grande)
    ====================================== */
    .sky {
      position:relative;
      background:#001025;
      height:44vh;         /* pi√π cielo */
      overflow:hidden;
      transition:background 1s linear;
    }

    @media(max-width:600px){
      .sky { height:42vh; }
    }

    /* Sole / Luna */
    .sunmoon {
      position:absolute;
      top:10%;
      left:-100px;
      width:90px;
      height:90px;
      border-radius:50%;
      z-index:5;
      transition:left 1.2s linear, top 1.2s linear;
      overflow:hidden;
    }

    .sunmoon.sun {
      background:radial-gradient(circle at 35% 35%, #fff8b0, #ffcc00, #ff9800);
      box-shadow:0 0 32px 10px rgba(255,200,0,0.9);
    }

    .sunmoon.moon {
      background:radial-gradient(circle at 40% 40%, #ffffff, #cfd8dc);
      box-shadow:0 0 22px 8px rgba(210,220,255,0.9);
    }

    .moon-phase-mask {
      position:absolute;
      inset:0;
      background:#001025;
      border-radius:50%;
      transition:transform 0.8s ease;
    }

    .sunmoon.sun .moon-phase-mask {
      display:none;
    }

    .sunmoon.moon .moon-phase-mask {
      display:block;
    }

    .sunmoon.phase-0 .moon-phase-mask { transform:scaleX(1); }
    .sunmoon.phase-1 .moon-phase-mask { transform:translateX(-35%) scaleX(0.2); }
    .sunmoon.phase-2 .moon-phase-mask { transform:translateX(-18%) scaleX(0.5); }
    .sunmoon.phase-3 .moon-phase-mask { transform:translateX(-8%)  scaleX(0.8); }
    .sunmoon.phase-4 .moon-phase-mask { transform:scaleX(0.02); }
    .sunmoon.phase-5 .moon-phase-mask { transform:translateX(8%)  scaleX(0.8); }
    .sunmoon.phase-6 .moon-phase-mask { transform:translateX(18%) scaleX(0.5); }
    .sunmoon.phase-7 .moon-phase-mask { transform:translateX(35%) scaleX(0.2); }

    /* COMETA (1‚Äì25 dicembre) */
    .comet {
      position:absolute;
      top:14vh;
      left:-200px;
      width:70px;
      height:70px;
      z-index:4;
      opacity:0;
      transition:left 2s linear, top 1.5s linear, opacity 1s ease, transform 0.8s ease;
      background:radial-gradient(circle, #ffffff, #ffe9a3, #ffcc00);
      box-shadow:0 0 24px 10px rgba(255,230,150,0.9);
      clip-path:polygon(
        50% 0%,
        62% 35%,
        98% 35%,
        69% 55%,
        80% 95%,
        50% 72%,
        20% 95%,
        31% 55%,
        2% 35%,
        38% 35%
      );
    }

    .comet.big {
      transform:scale(1.7);
      box-shadow:0 0 40px 20px rgba(255,245,200,1);
    }

    .comet-tail {
      position:absolute;
      right:100%;
      top:50%;
      transform:translateY(-50%);
      width:220px;
      height:40px;
      background:linear-gradient(90deg, rgba(255,255,200,0.7), rgba(255,255,200,0));
      filter:blur(8px);
      border-radius:40px;
    }

    /* UNA STELLA CADENTE OGNI TANTO (semplice) */
    .shooting-star {
      position:absolute;
      width:2px;
      height:2px;
      background:white;
      border-radius:50%;
      opacity:0;
      box-shadow:0 0 8px #fff;
    }

    @keyframes shoot {
      0%   { opacity:0; transform:translate(-200px,-150px); }
      10%  { opacity:1; }
      100% { opacity:0; transform:translate(400px,200px); }
    }

    /* ======================================
       CONTENUTO
    ====================================== */
    .content {
      position:relative;
      z-index:10;
      max-width:1200px;
      margin:0 auto;
      padding:14px;
      margin-top:-4vh;     /* lascia pi√π cielo ma porta su le card */
      text-align:center;
    }

    h1 {
      font-size:1.5rem;
      text-shadow:0 0 14px #00aaff;
      margin-bottom:4px;
    }

    .sun-times {
      font-size:0.9rem;
      opacity:0.9;
      margin-bottom:6px;
    }

    .status-bar {
      margin-bottom:12px;
      font-size:0.9rem;
      opacity:0.85;
    }

    /* ======================================
       CARD VENTO / PIOGGIA
    ====================================== */
    .cards-top {
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:14px;
      margin-bottom:14px;
    }

    .card {
      background:rgba(13,18,35,0.9);
      border-radius:14px;
      padding:16px;           /* pi√π piccole (prima 22‚Äì26) */
      width:40%;
      min-width:240px;
      box-shadow:0 0 16px rgba(0,0,0,0.6);
      text-align:center;
    }

    .card-header {
      font-size:1.1rem;
      margin-bottom:6px;
      opacity:0.95;
    }

    .wind-value, .rain-value {
      font-size:2rem;         /* ridotto del ~25% */
      font-weight:700;
      margin-top:6px;
    }

    .wind-extra {
      margin-top:8px;
      font-size:0.85rem;
      opacity:0.9;
      line-height:1.3;
    }

    .rain-value {
      color:#7cd8ff;
    }

    /* ======================================
       CARD METEO BASE (4 card)
    ====================================== */
    .bottom-cards {
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
      margin-top:6px;
    }

    .bottom-card {
      background:rgba(16,22,45,0.9);
      border-radius:14px;
      padding:14px;
      text-align:center;
      box-shadow:0 0 12px rgba(0,0,0,0.6);
    }

    .bottom-card .card-header {
      font-size:1rem;
      margin-bottom:4px;
    }

    .bottom-card .value {
      font-size:1.6rem;      /* pi√π piccole */
      font-weight:700;
      margin-top:4px;
    }

    .bottom-card .unit {
      font-size:0.8rem;
      opacity:0.8;
      margin-top:2px;
    }

    @media(max-width:800px){
      .card { width:46%; }
    }

    @media(max-width:600px){
      .card { width:100%; }
      .bottom-cards { grid-template-columns:1fr; }
      .content { margin-top:-2vh; }
    }
  </style>
</head>

<body>

<!-- =======================
     CIELO
======================= -->
<div class="sky" id="sky">
  <!-- Sole / Luna -->
  <div class="sunmoon" id="sunMoon">
    <div class="moon-phase-mask" id="moonMask"></div>
  </div>

  <!-- Cometa -->
  <div class="comet" id="comet">
    <div class="comet-tail"></div>
  </div>

  <!-- Una stella cadente "random" -->
  <div class="shooting-star" id="shootingStar"></div>
</div>

<!-- =======================
     CONTENUTO
======================= -->
<div class="content">
  <h1>üåü Langini Meteo ‚Äì Dashboard V8.9.1</h1>
  <div id="sunTimes" class="sun-times">Alba: --:-- ‚Ä¢ Tramonto: --:--</div>
  <div id="statusText" class="status-bar">Caricamento dati‚Ä¶</div>

  <!-- VENTO + PIOGGIA -->
  <div class="cards-top">
    <div class="card">
      <div class="card-header">üå¨Ô∏è Vento attuale</div>
      <div id="windNow" class="wind-value">-- km/h</div>
      <div class="wind-extra">
        <div id="windAvg">Media 24h: -- km/h</div>
        <div id="windKwh">Energia annua stimata: -- kWh</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">üåßÔ∏è Stato Pioggia</div>
      <div id="rainState" class="rain-value">--</div>
    </div>
  </div>

  <!-- METEO BASE -->
  <div class="bottom-cards">
    <div class="bottom-card">
      <div class="card-header">üå°Ô∏è Temperatura</div>
      <div id="tempValue" class="value">--</div>
      <div class="unit">¬∞C</div>
    </div>
    <div class="bottom-card">
      <div class="card-header">üíß Umidit√†</div>
      <div id="humValue" class="value">--</div>
      <div class="unit">%</div>
    </div>
    <div class="bottom-card">
      <div class="card-header">üå™Ô∏è Pressione</div>
      <div id="pressureValue" class="value">--</div>
      <div class="unit">hPa</div>
    </div>
    <div class="bottom-card">
      <div class="card-header">üå´Ô∏è Qualit√† Aria</div>
      <div id="aqValue" class="value">--</div>
      <div class="unit">AQI</div>
    </div>
  </div>
</div>

<script>
  // ================== CONFIG THINGSPEAK ==================
const WIND_JSON_URL = "https://raw.githubusercontent.com/972Davide/Langini_Meteo_Wind.html/main/data.json";

  
  const CH_METEO = 3149218;   // pressione, temp, umidit√†, AQI
  const CH_WIND  = 2956240;   // vento, pioggia

  // API READ KEY vento/pioggia (fix ufficiale)
  const WIND_API_KEY = "2B5OCENVF8TW06WZ";

  const LAT = 45.7525;
  const LON = 8.8975;

  function clamp(v,a,b){ return Math.min(b,Math.max(a,v)); }
  function toNum(v){ const n=parseFloat(v); return isNaN(n)?0:n; }

  // ================== FASI LUNARI ==================
  function moonPhaseIndex(date){
    const lp=2551443;
    const new_moon=Date.UTC(1970,0,7,20,35,0);
    const now=date.getTime();
    const phase=((now-new_moon)/1000)%lp;
    return Math.floor((phase/lp)*8+0.5)&7;
  }

  // ================== CIELO / SOLE / LUNA ==================
  function updateSky(){
    const now=new Date();
    const times=SunCalc.getTimes(now,LAT,LON);
    const pos=SunCalc.getPosition(now,LAT,LON);
    const alt=pos.altitude*180/Math.PI;

    const SKY=document.getElementById("sky");
    const SM=document.getElementById("sunMoon");

    const isDay = now>=times.sunrise && now<=times.sunset;

    const fmt = d => d.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
    document.getElementById("sunTimes").textContent =
      "Alba: "+fmt(times.sunrise)+" ‚Ä¢ Tramonto: "+fmt(times.sunset);

    if(isDay){
      SM.classList.add("sun");
      SM.classList.remove("moon");
      SKY.style.background = "#001f3a";
    }else{
      SM.classList.remove("sun");
      SM.classList.add("moon");
      SKY.style.background = "#000814";

      const idx=moonPhaseIndex(now);
      for(let i=0;i<8;i++) SM.classList.remove("phase-"+i);
      SM.classList.add("phase-"+idx);
    }

    const start=isDay?times.sunrise:times.sunset;
    const end=isDay?times.sunset:new Date(times.sunrise.getTime()+86400000);
    let p=(now-start)/(end-start);
    p=clamp(p,0,1);

    const W=window.innerWidth;
    const baseTop=window.innerHeight*0.03;
    const amp=window.innerHeight*0.18;
    const y=baseTop + (1-Math.sin(p*Math.PI))*amp;

    SM.style.left = (p*(W+200)-100)+"px";
    SM.style.top  = y+"px";
  }

  // ================== COMETA (1‚Äì25 dicembre) ==================
  function updateComet(){
    const comet=document.getElementById("comet");
    const now=new Date();
    const m=now.getMonth();
    const d=now.getDate();

    if(m!==11 || d<1 || d>25){
      comet.style.opacity=0;
      comet.classList.remove("big");
      return;
    }

    const width=window.innerWidth;
    comet.style.opacity=1;

    if(d<25){
      const progress=(d-1)/24;
      const left=-200 + progress*(width+200);
      comet.classList.remove("big");
      comet.style.top = "14vh";
      comet.style.left = left+"px";
    }else{
      comet.classList.add("big");
      const size=70;
      comet.style.top="16vh";
      comet.style.left=(width/2 - size/2)+"px";
    }
  }

  // ================== STELLA CADENTE ==================
  function randomShootingStar(){
    const star=document.getElementById("shootingStar");
    const now=new Date();
    const times=SunCalc.getTimes(now,LAT,LON);
    const isNight = now < times.sunrise || now > times.sunset;
    if(!isNight) return;
    if(Math.random()<0.35){
      star.style.top = "5vh";
      star.style.left = "5vw";
      star.style.opacity=1;
      star.style.animation="none";
      void star.offsetWidth;
      star.style.animation="shoot 1.6s linear forwards";
    }
  }

  // ================== KWH EOLICI ==================
  function calcKwh(media_kmh){
    const v = media_kmh / 3.6;
    const A = 0.85 * 0.59;
    const rho = 1.225;
    const Cp = 0.25;
    const P = 0.5 * rho * A * Cp * Math.pow(v,3);
    const kWhAnno = P * 24 * 365 / 1000;
    return kWhAnno.toFixed(1);
  }

  // ================== DASHBOARD (V8.9.2) ==================
  async function updateDashboard(){
    try{

      // --- METEO BASE ---
      const meteo = await fetch(
        `https://api.thingspeak.com/channels/${CH_METEO}/feeds.json?results=1`
      ).then(r=>r.json());

      const m = meteo.feeds?.[0] || {};

      document.getElementById("pressureValue").textContent =
        m.field1 ? parseFloat(m.field1).toFixed(0) : "--";
      document.getElementById("tempValue").textContent =
        m.field2 ? parseFloat(m.field2).toFixed(1) : "--";
      document.getElementById("humValue").textContent =
        m.field3 ? parseFloat(m.field3).toFixed(0) : "--";
      document.getElementById("aqValue").textContent =
        m.field4 ? parseFloat(m.field4).toFixed(0) : "--";

     // --- VENTO / PIOGGIA da GitHub JSON ---
const windJson = await fetch(WIND_JSON_URL + "?t=" + Date.now()).then(r => r.json());

const windNow = toNum(windJson.wind_kmh);
document.getElementById("windNow").textContent =
  windNow ? windNow.toFixed(1) + " km/h" : "-- km/h";

// stato pioggia
const rainVal = toNum(windJson.rain);
const rEl = document.getElementById("rainState");
if (rainVal >= 1) {
  rEl.textContent = "Pioggia";
  rEl.style.color = "#ff7b7b";
  rEl.style.textShadow = "0 0 10px #ff4d4d";
} else {
  rEl.textContent = "Asciutto";
  rEl.style.color = "#7cd8ff";
  rEl.style.textShadow = "0 0 10px #29aaff";
}

// disattiva media 24h (nessuno storico GitHub disponibile)
document.getElementById("windAvg").textContent = "Media 24h: -- km/h";
document.getElementById("windKwh").textContent = "Energia annua stimata: -- kWh";

// timestamp locale
document.getElementById("statusText").textContent =
  "Aggiornato: " + new Date().toLocaleTimeString("it-IT");
    

      // --- MEDIA 24H ---
      const vals = feedsW
        .map(f=>parseFloat(f.field1))
        .filter(v=>!isNaN(v));

      let media = vals.length
        ? vals.reduce((a,b)=>a+b,0)/vals.length
        : 0;

      document.getElementById("windAvg").textContent =
        "Media 24h: "+(media?media.toFixed(1):"--")+" km/h";

      document.getElementById("windKwh").textContent =
        media ? ("Energia annua stimata: "+calcKwh(media)+" kWh")
              : "Energia annua stimata: -- kWh";

      const ts = lastW.created_at || m.created_at || new Date().toISOString();
      document.getElementById("statusText").textContent =
        "Aggiornato: "+ new Date(ts).toLocaleTimeString("it-IT");

    }catch(e){
      console.log("Errore updateDashboard:", e);
      document.getElementById("statusText").textContent =
        "Errore connessione dati";
    }
  }

  // ================== LOOP PERIODICI ==================
  function tickSkyAll(){
    updateSky();
    updateComet();
  }

  tickSkyAll();
  updateDashboard();
  setInterval(tickSkyAll, 12000);
  setInterval(updateDashboard, 25000); // FIX UFFICIALE
  setInterval(randomShootingStar, 8000);

  window.addEventListener("resize", ()=>{
    updateSky();
    updateComet();
  });
</script>


</body>
</html>
