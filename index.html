<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Langini Meteo ‚Äì Dashboard V8.2 CLEAN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    :root {
      --card-bg: #f8fbff;
      --card-border: #d0e0ff;
      --text-main: #0b1b3a;
      --text-muted: #6b7a99;
      --accent: #ffc107;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background:#000814;
      color:#fff;
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* CIELO COMPLETAMENTE LISCIO (NO PUNTINI, NO STRATI) */
    .sky {
      position:relative;
      flex:1;
      background:#1f2b3a; /* Giorno */
      transition: background 1.5s linear;
      overflow:hidden;
    }
    .sky.night {
      background:#000814; /* Notte */
    }

    /* NUVOLE */
    .cloud-layer {
      position:absolute;
      top:10%;
      left:-50%;
      width:200%;
      height:40%;
      background-repeat:repeat-x;
      opacity:0.25;
      z-index:1;
      pointer-events:none;
    }
    .cloud-layer.front {
      top:15%;
      height:35%;
      opacity:0.35;
      animation: cloudsFront 60s linear infinite;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.35) 0, transparent 40%),
        radial-gradient(circle at 35% 40%, rgba(255,255,255,0.30) 0, transparent 40%),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,0.28) 0, transparent 40%);
    }

    .cloud-layer.back {
      top:5%;
      height:30%;
      opacity:0.18;
      animation: cloudsBack 120s linear infinite;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.18) 0, transparent 45%),
        radial-gradient(circle at 60% 20%, rgba(255,255,255,0.14) 0, transparent 45%);
    }

    @keyframes cloudsFront {
      from { transform:translateX(0); }
      to { transform:translateX(-25%); }
    }
    @keyframes cloudsBack {
      from { transform:translateX(0); }
      to { transform:translateX(-15%); }
    }

    /* AURORA */
    .aurora {
      position:absolute;
      top:5%;
      left:0;
      width:100%;
      height:40%;
      background:linear-gradient(180deg, rgba(120,255,200,0.4), rgba(80,120,255,0.0));
      opacity:0;
      z-index:1;
      filter:blur(6px);
      animation: auroraWave 12s ease-in-out infinite alternate;
      pointer-events:none;
      transition:opacity 1s ease;
    }
    @keyframes auroraWave {
      0% { transform:translateX(-3%); }
      50% { transform:translateX(4%); }
      100% { transform:translateX(0%); }
    }

    /* NEBBIA */
    .fog {
      position:absolute;
      bottom:0;
      left:-20%;
      width:140%;
      height:30%;
      background:radial-gradient(circle at 20% 80%, rgba(255,255,255,0.18), transparent 60%),
                 radial-gradient(circle at 60% 90%, rgba(255,255,255,0.2), transparent 60%);
      opacity:0;
      pointer-events:none;
      z-index:2;
      filter:blur(4px);
      transition:opacity 1s ease;
      animation:fogDrift 40s linear infinite;
    }
    @keyframes fogDrift {
      0% { transform:translateX(0); }
      100% { transform:translateX(6%); }
    }

    /* FULMINE */
    .lightning {
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 30% 0%, rgba(255,255,255,0.85), transparent 45%);
      opacity:0;
      z-index:4;
      pointer-events:none;
      transition:opacity 0.15s ease;
    }
    .lightning.flash { opacity:0.8; }

    /* STELLA CADENTE */
    .shooting-star {
      position:absolute;
      top:-5%;
      left:-5%;
      width:120px;
      height:2px;
      background:linear-gradient(90deg, rgba(255,255,255,0.9), transparent);
      opacity:0;
      transform:rotate(25deg);
      pointer-events:none;
      z-index:3;
    }
    .shooting-star.active {
      animation: shooting 1.2s ease-out forwards;
    }
    @keyframes shooting {
      0% { opacity:0; transform:translate(-10vw,-10vh) rotate(25deg); }
      20% { opacity:1; }
      100% { opacity:0; transform:translate(40vw,40vh) rotate(25deg); }
    }

    /* SOLE/LUNA */
    .sunmoon {
      position:absolute;
      top:20%;
      left:-80px;
      width:70px;
      height:70px;
      border-radius:50%;
      z-index:3;
      transition:left 1.5s linear, top 1.5s linear;
      display:flex; align-items:center; justify-content:center;
    }
    .sun {
      background:radial-gradient(circle at 35% 35%, #fff8b0, #ffcc00, #ff9800);
      box-shadow:0 0 25px 12px rgba(255,180,0,0.8);
      animation:sunPulse 5s ease-in-out infinite;
    }
    @keyframes sunPulse {
      0% { box-shadow:0 0 20px 8px rgba(255,180,0,0.6); }
      50% { box-shadow:0 0 32px 14px rgba(255,204,0,1); }
      100% { box-shadow:0 0 20px 8px rgba(255,180,0,0.6); }
    }

    .moon {
      background:radial-gradient(circle at 40% 40%, #ffffff, #cfd8dc);
      box-shadow:0 0 18px 8px rgba(200,200,255,0.5);
      animation:moonGlow 6s ease-in-out infinite;
      position:relative;
      overflow:hidden;
    }
    @keyframes moonGlow {
      0% { box-shadow:0 0 14px 6px rgba(200,200,255,0.4); }
      50% { box-shadow:0 0 22px 10px rgba(220,220,255,0.7); }
      100% { box-shadow:0 0 14px 6px rgba(200,200,255,0.4); }
    }

    /* Maschera fase lunare */
    .moon-phase-mask {
      position:absolute;
      inset:0;
      border-radius:50%;
      background:#000814;
      box-shadow:inset 0 0 8px rgba(0,0,0,0.5);
      transform-origin:center center;
    }

    /* Fasi lunari 0..7 */
    .moon.phase-0 .moon-phase-mask { transform:scaleX(1); }
    .moon.phase-1 .moon-phase-mask { transform:translateX(-35%) scaleX(0.2); }
    .moon.phase-2 .moon-phase-mask { transform:translateX(-15%) scaleX(0.5); }
    .moon.phase-3 .moon-phase-mask { transform:translateX(-8%) scaleX(0.8); }
    .moon.phase-4 .moon-phase-mask { transform:scaleX(0.02); }
    .moon.phase-5 .moon-phase-mask { transform:translateX(8%) scaleX(0.8); }
    .moon.phase-6 .moon-phase-mask { transform:translateX(15%) scaleX(0.5); }
    .moon.phase-7 .moon-phase-mask { transform:translateX(35%) scaleX(0.2); }

    /* CONTENUTO */
    .content { max-width:1200px; margin:0 auto; padding:16px; z-index:5; }

    h1 { text-align:center; font-size:1.4rem; font-weight:700; margin-bottom:6px; }

    .subtitle { text-align:center; font-size:0.9rem; margin-bottom:10px; }

    .btn-realtime {
      display:inline-block;
      margin:0 auto 10px;
      padding:10px 20px;
      background:#ff9500;
      color:#fff;
      border-radius:12px;
      text-decoration:none;
      font-weight:700;
      box-shadow:0 0 12px rgba(255,149,0,0.7);
    }

    .status-bar {
      text-align:center;
      font-size:0.85rem;
      margin-bottom:10px;
    }

    /* CARDS */
    .cards { display:grid; gap:14px; margin-top:16px; }
    .cards-top { grid-template-columns:1fr 1fr; }
    .cards-bottom { grid-template-columns:repeat(4,1fr); }

    @media(max-width:900px) {
      .cards-bottom { grid-template-columns:1fr 1fr; }
    }
    @media(max-width:600px) {
      .cards-top, .cards-bottom { grid-template-columns:1fr; }
    }

    .card {
      background:#fff;
      color:#000;
      border-radius:16px;
      padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,0.25);
    }

    .card-header { font-weight:600; margin-bottom:4px; }

    .value { font-size:1.8rem; font-weight:700; margin-top:6px; }
    .value-unit { font-size:0.8rem; color:#666; }

    .gauge { margin-top:10px; height:16px; background:#e0e0e0; border-radius:12px; }
    .gauge-fill {
      height:100%; background:linear-gradient(90deg,#ffb300,#ff6d00);
      width:0%; border-radius:inherit; transition:width 0.3s ease;
    }

    .rainstate-value { font-size:1.8rem; font-weight:700; text-align:center; }
    .rainstate-value.asciutto { color:#f57c00; }
    .rainstate-value.bagnato { color:#1e88e5; }

    .windmax-value { font-size:2rem; font-weight:700; text-align:center; }
  </style>
</head>

<body>
  <div class="sky" id="sky">
    <div class="cloud-layer back"></div>
    <div class="cloud-layer front"></div>
    <div class="aurora" id="aurora"></div>
    <div class="fog" id="fog"></div>
    <div class="lightning" id="lightning"></div>
    <div class="shooting-star" id="shootingStar"></div>

    <div class="sunmoon" id="sunMoon">
      <div class="moon-phase-mask" id="moonMask"></div>
    </div>

    <div class="content">
      <h1>üåü Langini Meteo ‚Äì Dashboard V8.2 CLEAN</h1>
      <div class="subtitle">Sky Premium, Fasi Lunari, Transizione Realistica, Dati Meteo Completi</div>

      <a href="http://192.168.1.20" class="btn-realtime">‚ö° Dati immediati</a>

      <div class="status-bar" id="statusText">Caricamento dati‚Ä¶</div>

      <div class="cards cards-top">
        <div class="card">
          <div class="card-header">üåÄ Velocit√† Max</div>
          <div class="windmax-value" id="windMaxValue">--</div>
          <div id="windMaxTime" style="font-size:0.8rem;color:#666;"></div>
        </div>

        <div class="card">
          <div class="card-header">üåßÔ∏è Pioggia</div>
          <div class="rainstate-value" id="rainState">--</div>
        </div>
      </div>

      <div class="cards cards-bottom">
        <div class="card">
          <div class="card-header">Pressione</div>
          <div class="value" id="pressureValue">--</div>
          <div class="value-unit">hPa</div>
          <div class="gauge"><div class="gauge-fill" id="gaugePressure"></div></div>
        </div>

        <div class="card">
          <div class="card-header">Temperatura</div>
          <div class="value" id="tempValue">--</div>
          <div class="value-unit">¬∞C</div>
          <div class="gauge"><div class="gauge-fill" id="gaugeTemp"></div></div>
        </div>

        <div class="card">
          <div class="card-header">Umidit√†</div>
          <div class="value" id="humValue">--</div>
          <div class="value-unit">%</div>
          <div class="gauge"><div class="gauge-fill" id="gaugeHum"></div></div>
        </div>

        <div class="card">
          <div class="card-header">Qualit√† Aria</div>
          <div class="value" id="aqValue">--</div>
          <div class="value-unit">AQI</div>
          <div class="gauge"><div class="gauge-fill" id="gaugeAQ"></div></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* CONFIG */
const METEO_CHANNEL = 3149218;
const WIND_CHANNEL  = 2956240;

const LAT = 45.7525;
const LON = 8.8975;

/* COLORI */
function interpolateColor(c1, c2, f) {
  const p1 = parseInt(c1.slice(1), 16);
  const p2 = parseInt(c2.slice(1), 16);

  const r1 = (p1>>16)&255, g1=(p1>>8)&255, b1=p1&255;
  const r2 = (p2>>16)&255, g2=(p2>>8)&255, b2=p2&255;

  const r = Math.round(r1 + (r2-r1)*f);
  const g = Math.round(g1 + (g2-g1)*f);
  const b = Math.round(b1 + (b2-b1)*f);

  return `rgb(${r},${g},${b})`;
}

/* FASE LUNARE */
function getMoonPhaseIndex(date){
  const lp = 2551443;
  const new_moon = Date.UTC(1970,0,7,20,35,0);
  const now = date.getTime();
  const phase = ((now - new_moon)/1000) % lp;
  return Math.floor((phase/lp) * 8 + 0.5) & 7;
}

/* TOOLS */
function toNumber(x){ const n=parseFloat(x); return isNaN(n)?0:n; }
function clamp(v,a,b){ return Math.min(b,Math.max(a,v)); }

async function fetchJson(u){ const r=await fetch(u); return r.json(); }

/* SOLE/LUNA + COLORE CIELO */
function updateSky() {
  const now = new Date();
  const times = SunCalc.getTimes(now, LAT, LON);
  const pos = SunCalc.getPosition(now, LAT, LON);

  const altDeg = pos.altitude * 180/Math.PI;

  const SUN = document.getElementById("sunMoon");
  const MASK = document.getElementById("moonMask");
  const SKY  = document.getElementById("sky");

  const isDay = now>=times.sunrise && now<=times.sunset;

  /* Sole/Luna */
  if(isDay){
    SUN.classList.add("sun");
    SUN.classList.remove("moon");
    MASK.style.display="none";
  } else {
    SUN.classList.remove("sun");
    SUN.classList.add("moon");
    MASK.style.display="block";

    const idx = getMoonPhaseIndex(now);
    for(let i=0;i<8;i++) SUN.classList.remove("phase-"+i);
    SUN.classList.add("phase-"+idx);
  }

  /* Traiettoria */
  let start = isDay ? times.sunrise : times.sunset;
  let end   = isDay ? times.sunset : new Date(times.sunrise.getTime()+86400000);

  let pct = (now-start)/(end-start); pct=clamp(pct,0,1);

  const W = window.innerWidth;
  const x = pct*(W+160)-80;
  const maxH = window.innerHeight*0.35;
  const y = maxH - Math.sin(pct*Math.PI)*maxH;

  SUN.style.left = `${x}px`;
  SUN.style.top  = `${y}px`;

  /* Colore realistico */
  const DAY  = "#1f2b3a";
  const NIGHT= "#000814";

  let blend;
  const ALT_NIGHT=-12, ALT_DAY=45;

  if(altDeg<=ALT_NIGHT) blend=0;
  else if(altDeg>=ALT_DAY) blend=1;
  else blend = (altDeg-ALT_NIGHT)/(ALT_DAY-ALT_NIGHT);

  blend = clamp(blend,0,1);

  SKY.style.background = interpolateColor(NIGHT, DAY, blend);

  if(altDeg<=0) SKY.classList.add("night");
  else SKY.classList.remove("night");
}

/* STELLA CADENTE */
function maybeShootStar(){
  const now=new Date();
  const t=SunCalc.getTimes(now,LAT,LON);
  const night = now<t.sunrise || now>t.sunset;
  if(!night) return;

  if(Math.random()<0.3){
    const s=document.getElementById("shootingStar");
    s.classList.add("active");
    setTimeout(()=>s.classList.remove("active"),1300);}
}

/* DASHBOARD DATI */
let windMax=parseFloat(localStorage.getItem("windMax")||"0");
let windMaxDate=localStorage.getItem("windMaxDate")||"--";

function updateWindMaxDisplay(){
  document.getElementById("windMaxValue").textContent=
    windMax>0?windMax.toFixed(1)+" km/h":"--";
  document.getElementById("windMaxTime").textContent=windMaxDate;
}

updateWindMaxDisplay();

async function updateDashboard(){
  try{
    const [meteo,wind]=await Promise.all([
      fetchJson(`https://api.thingspeak.com/channels/${METEO_CHANNEL}/feeds.json?results=60`),
      fetchJson(`https://api.thingspeak.com/channels/${WIND_CHANNEL}/feeds.json?results=60`)
    ]);

    const m=meteo.feeds?.at(-1)||{};
    const w=wind.feeds?.at(-1)||{};

    const pressure=toNumber(m.field1);
    const temp=toNumber(m.field2);
    const hum=toNumber(m.field3);
    const aqi=toNumber(m.field4);

    document.getElementById("pressureValue").textContent=pressure.toFixed(0);
    document.getElementById("tempValue").textContent=temp.toFixed(0);
    document.getElementById("humValue").textContent=hum.toFixed(0);
    document.getElementById("aqValue").textContent=aqi.toFixed(0);

    document.getElementById("gaugePressure").style.width=
      clamp((pressure-950)/100*100,0,100)+"%";
    document.getElementById("gaugeTemp").style.width=
      clamp((temp+10)/60*100,0,100)+"%";
    document.getElementById("gaugeHum").style.width=hum+"%";
    document.getElementById("gaugeAQ").style.width=
      clamp(aqi/500*100,0,100)+"%";

    /* Pioggia */
    const rain=toNumber(w.field2);
    const rEl=document.getElementById("rainState");
    if(rain>=1){
      rEl.textContent="Bagnato";
      rEl.classList.remove("asciutto");
      rEl.classList.add("bagnato");
    } else {
      rEl.textContent="Asciutto";
      rEl.classList.remove("bagnato");
      rEl.classList.add("asciutto");
    }

    /* Vento max */
    const windVal=toNumber(w.field1);
    if(windVal>windMax){
      windMax=windVal;
      const now=new Date();
      windMaxDate=
        now.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})+
        " - "+now.toLocaleDateString("it-IT");
      localStorage.setItem("windMax",windMax.toFixed(1));
      localStorage.setItem("windMaxDate",windMaxDate);
    }
    updateWindMaxDisplay();

    document.getElementById("statusText").textContent=
      "Aggiornato: "+new Date(w.created_at||m.created_at).toLocaleTimeString("it-IT");

    /* Animazioni meteo */
    const aur=document.getElementById("aurora");
    const fog=document.getElementById("fog");
    const lightning=document.getElementById("lightning");

    const hour=(new Date()).getHours();
    const isNight = now<t.sunrise || now>t.sunset;

    if(isNight && aqi<80 && hum<85) aur.style.opacity=0.45;
    else aur.style.opacity=0;

    if(hour<9 && hum>85) fog.style.opacity=0.6;
    else fog.style.opacity=0;

    if(rain>=1 && windVal>20 && Math.random()<0.2){
      lightning.classList.add("flash");
      setTimeout(()=>lightning.classList.remove("flash"),150);
    }

  }catch(e){
    console.log("Errore:",e);
  }
}

/* LOOP */
setInterval(updateDashboard,20000);
setInterval(updateSky,10000);
setInterval(maybeShootStar,15000);

updateDashboard();
updateSky();
</script>
</body>
</html>
