function updateSky() {
  if (!timesToday || !timesTomorrow) return;

  const now = new Date();
  const sunrise = timesToday.sunrise;
  const sunset = timesToday.sunset;
  const nextSunrise = timesTomorrow.sunrise;
  const isDay = (now >= sunrise && now < sunset);

  const sky = document.getElementById('sky');
  const stars = document.getElementById('stars');
  const sun = document.getElementById('sun');
  const moon = document.getElementById('moon');
  const label = document.getElementById('astroCountdown');

  const TW = 60 * 60000; // 1 ora transizione
  let bg1, bg2;

  // --- sfondo graduale ---
  if (now >= new Date(sunrise - TW) && now < new Date(sunrise + TW)) {
    const p = (now - (sunrise - TW)) / (2 * TW);
    bg1 = `#${mixColor([0x00, 0x10, 0x28], [0xff, 0xa4, 0x52], p)}`;
    bg2 = `#${mixColor([0x00, 0x2a, 0x4f], [0x7e, 0xc9, 0xff], p)}`;
  } else if (now >= new Date(sunset - TW) && now < new Date(sunset + TW)) {
    const p = (now - (sunset - TW)) / (2 * TW);
    bg1 = `#${mixColor([0x7e, 0xc9, 0xff], [0x00, 0x10, 0x28], p)}`;
    bg2 = `#${mixColor([0x2b, 0x77, 0xd0], [0x00, 0x2a, 0x4f], p)}`;
  } else if (isDay) { bg1 = '7ec9ff'; bg2 = '2b77d0'; }
  else { bg1 = '001028'; bg2 = '002a4f'; }

  sky.style.background = `linear-gradient(to bottom, #${bg1}, #${bg2})`;
  stars.style.opacity = isDay ? '0' : '1';

  // --- movimento e transizione sole/luna ---
  if (isDay) {
    const p = (now - sunrise) / (sunset - sunrise);
    const x = lerp(-10, 110, p);
    const y = 35 - 15 * Math.sin(Math.PI * p);

    sun.style.left = x + '%';
    sun.style.top = y + '%';
    sun.style.opacity = 1;

    // luna si dissolve mentre sole entra
    const fade = Math.max(0, 1 - p * 3);
    moon.style.opacity = fade;
  } else {
    const nightStart = sunset;
    const nightEnd = nextSunrise;
    const p = (now - nightStart) / (nightEnd - nightStart);
    const x = lerp(-10, 110, p);
    const y = 40 - 10 * Math.sin(Math.PI * p);

    moon.style.left = x + '%';
    moon.style.top = y + '%';
    moon.style.opacity = 1;

    // sole riappare gradualmente appena luna esce a dx
    const fade = Math.max(0, 1 - Math.abs(p - 1) * 3);
    if (p > 0.95) {
      sun.style.left = '-10%';
      sun.style.opacity = (p - 0.95) * 20; // fade in rapido
    } else {
      sun.style.opacity = 0;
    }
  }

  // --- countdown sincronizzato ---
  let target, icon;
  if (isDay) {
    target = sunset;
    icon = "â˜€ï¸ Tramonto tra";
  } else {
    const nextTarget = (now > sunrise) ? nextSunrise : sunrise;
    target = nextTarget;
    icon = "ðŸŒ™ Alba tra";
  }

  const diff = Math.max(target - now, 0);
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);

  label.innerHTML = `${icon} <b>${h}h ${m}min</b>`;
}
